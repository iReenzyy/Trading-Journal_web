<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дневник трейдера</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: linear-gradient(135deg, #1E2A44 0%, #0F172A 100%);
            color: #ECF0F1;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: fadeIn 1.5s ease-in-out;
        }
        .card {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 247, 255, 0.2);
        }
        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #FFFFFF;
            border-radius: 5px;
            transition: all 0.3s ease;
            height: 40px;
        }
        .form-control:focus, .form-select:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: #00F7FF;
            box-shadow: 0 0 5px rgba(0, 247, 255, 0.5);
            color: #FFFFFF;
        }
        .form-select option {
            background: #1E2A44;
            color: #FFFFFF;
        }
        .form-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            color: #A0B1C5;
        }
        .btn {
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
            box-shadow: 0 0 5px rgba(0, 247, 255, 0.5);
        }
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0, 247, 255, 0.8);
        }
        .btn-action {
            background: #1E2A44;
            color: #00F7FF;
            border: 1px solid #00F7FF;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.8rem;
            margin: 0 2px;
            transition: all 0.3s ease;
        }
        .btn-action:hover {
            background: #00F7FF;
            color: #1E2A44;
            box-shadow: 0 0 5px #00F7FF;
        }
        .btn-add-coin {
            background: #00F7FF;
            color: #1E2A44;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 1rem;
            margin-left: 5px;
            transition: all 0.3s ease;
        }
        .btn-add-coin:hover {
            background: #FF00E6;
            color: #FFFFFF;
            box-shadow: 0 0 5px #FF00E6;
        }
        .table {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 10px;
            overflow: hidden;
            width: 100%;
            display: block;
            overflow-x: auto;
        }
        .table th {
            background: rgba(255, 255, 255, 0.1);
            color: #00F7FF;
            text-transform: uppercase;
            font-size: 0.9rem;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            text-align: center;
            padding: 8px;
            cursor: pointer;
        }
        .table th:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .table td {
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #FFFFFF;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            text-align: center;
            padding: 8px;
            max-width: 150px;
        }
        .table td.setup-cell, .table td.notes-cell {
            max-width: 100px;
        }
        .table td:first-child, .table th:first-child {
            border-top-left-radius: 10px;
            border-bottom-left-radius: 10px;
        }
        .table td:last-child, .table th:last-child {
            border-top-right-radius: 10px;
            border-bottom-right-radius: 10px;
        }
        @media (min-width: 969px) {
            .table {
                display: table;
                overflow-x: visible;
                width: 100%;
                margin-left: 0;
                margin-right: 0;
            }
            #view .col-6 .form-select,
            #view .col-6 .form-control {
                width: 220px;
            }
            #view .col-6 .input-with-button {
                position: relative;
                width: 220px;
            }
            #view .col-6 .input-with-button .fas.fa-calendar-alt {
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                color: #A0B1C5;
                cursor: pointer;
            }
        }
        #view .row.mb-3 {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        #view .card {
            padding: 15px;
        }
        .navbar {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px 0;
            position: fixed;
            bottom: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .navbar-brand {
            color: #ECF0F1;
            font-size: 1.1rem;
            padding: 10px 15px;
            border-radius: 5px;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            align-items: center;
            text-decoration: none;
        }
        .navbar-brand i {
            margin-right: 8px;
        }
        .navbar-brand:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #00F7FF;
            box-shadow: 0 0 5px rgba(0, 247, 255, 0.5);
        }
        .lang-toggle {
            position: relative;
            padding: 10px 15px;
            border-radius: 5px;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .lang-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #00F7FF;
            box-shadow: 0 0 5px rgba(0, 247, 255, 0.5);
        }
        .lang-icon {
            font-weight: bold;
            color: #00F7FF;
            margin-right: 5px;
        }
        .lang-dropdown {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 5px 0;
            min-width: 80px;
            box-shadow: 0 0 10px rgba(0, 247, 255, 0.3);
            z-index: 1000;
            animation: slideDown 0.3s ease-out;
        }
        .lang-dropdown.active {
            display: block;
        }
        .lang-option {
            color: #ECF0F1;
            padding: 5px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .lang-option:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #00F7FF;
        }
        .spinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .spinner-circle {
            width: 50px;
            height: 50px;
            border: 5px solid #00F7FF;
            border-top: 5px solid #FF00E6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .stats-container {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(15px);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 60px;
        }
        .stats-container h3 {
            color: #00F7FF;
            font-size: 1.8rem;
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            justify-items: center;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            width: 100%;
            max-width: 200px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: float 3s ease-in-out infinite;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 15px rgba(0, 247, 255, 0.5);
        }
        .stat-card h4 {
            color: #A0B1C5;
            font-size: 1rem;
            margin: 10px 0 5px;
            text-transform: uppercase;
        }
        .stat-card p {
            margin: 0;
            font-size: 1.2rem;
            color: #FFFFFF;
        }
        .stat-card span {
            color: #00F7FF;
            font-weight: bold;
            font-size: 1.3rem;
        }
        .stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .stat-icon.profit {
            color: #00F7FF;
        }
        .stat-icon.loss {
            color: #FF00E6;
        }
        @keyframes float {
            0% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0); }
        }
        .progress-bar {
            width: 0;
            height: 20px;
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            color: #1E2A44;
            font-weight: bold;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .progress-bar span {
            line-height: 20px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            color: #FFFFFF;
        }
        /* Подсказки включены только вне #view */
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]:hover:after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            color: #1E2A44;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 0 5px rgba(0, 247, 255, 0.5);
            pointer-events: none;
        }
        /* Отключаем подсказки внутри #view */
        #view [data-tooltip]:hover:after {
            display: none;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        .input-with-button {
            position: relative;
            display: flex;
            align-items: center;
        }
        .input-with-button .form-control {
            padding-right: 30px;
            width: 100%;
        }
        .input-with-button .fas.fa-calendar-alt {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #A0B1C5;
            cursor: pointer;
        }
        .btn-add-image {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 3px;
            padding: 2px 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-add-image:hover {
            background: #00F7FF;
            color: #1E2A44;
        }
        .btn-add-image i {
            font-size: 0.9rem;
        }
        /* Стили для модального окна */
        .modal-content {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ECF0F1;
        }
        .modal-header, .modal-footer {
            background: rgba(15, 23, 42, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            border-top: none;
        }
        .modal-body {
            background: rgba(15, 23, 42, 0.9);
            padding: 15px;
        }
        .modal-body p {
            margin: 0 0 10px;
        }
        .modal-body img {
            max-width: 100%;
            border-radius: 5px;
        }
        /* Стили для ползунка рейтинга */
        .rating-wrapper {
            position: relative;
            width: 100%;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .form-range {
            position: absolute;
            width: 100%;
            height: 10px;
            z-index: 2;
            cursor: pointer;
            -webkit-appearance: none;
            background: transparent;
        }
        .form-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #00F7FF;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 247, 255, 0.5);
            transition: transform 0.3s ease, background 0.3s ease; /* Плавное изменение ползунка */
        }
        .form-range::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #00F7FF;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 247, 255, 0.5);
            transition: transform 0.3s ease, background 0.3s ease; /* Плавное изменение ползунка */
        }
        .form-range::-webkit-slider-runnable-track {
            height: 10px;
            background: transparent;
        }
        .form-range::-moz-range-track {
            height: 10px;
            background: transparent;
        }
        .rating-track {
            position: absolute;
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1); /* Белое пространство */
            border-radius: 5px;
            overflow: hidden;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1;
        }
        .rating-fill {
            height: 100%;
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            border-radius: 5px;
            position: absolute;
            left: 0;
            top: 0;
            z-index: 0;
            width: 0;
        }
        .rating-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            z-index: 1;
            transition: all 0.3s ease;
        }
        @media (max-width: 968px) {
            h1 { font-size: 1.5rem; }
            .card { padding: 10px; }
            .form-label { font-size: 0.8rem; }
            .form-control, .form-select { font-size: 0.9rem; height: 35px; }
            .btn { padding: 6px 12px; font-size: 0.8rem; }
            .table { font-size: 0.8rem; }
            .table th, .table td { padding: 6px; }
            .navbar-brand { 
                font-size: 0.7rem;
                padding: 6px 8px;
            }
            .lang-toggle { 
                font-size: 0.7rem;
                padding: 6px 8px;
            }
            .lang-icon { font-size: 0.6rem; }
            .lang-dropdown { min-width: 60px; }
            .lang-option { font-size: 0.6rem; padding: 3px 8px; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
            .stat-card { padding: 10px; max-width: 150px; }
            .stat-card h4 { font-size: 0.9rem; }
            .stat-card p { font-size: 1rem; }
            .stat-card span { font-size: 1.1rem; }
            .stat-icon { font-size: 1.5rem; }
            .rating-value {
                font-size: 1rem;
                top: -18px;
            }
            .rating-track, .form-range {
                height: 8px;
            }
            .rating-fill {
                height: 8px;
            }
            .form-range::-webkit-slider-thumb {
                width: 14px;
                height: 14px;
                transition: transform 0.3s ease, background 0.3s ease;
            }
            .form-range::-moz-range-thumb {
                width: 14px;
                height: 14px;
                transition: transform 0.3s ease, background 0.3s ease;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="fade-in"><i class="fas fa-chart-line"></i> Дневник трейдера</h1>

        <div id="main" class="card fade-in">
            <div class="row mb-2">
                <div class="col-6">
                    <label for="coin" class="form-label" data-tooltip="Выберите или добавьте монету">Монета</label>
                    <div class="d-flex">
                        <select class="form-select" id="coin" required>
                            <option value="BTCUSD">BTCUSD</option>
                            <option value="ETHUSD">ETHUSD</option>
                            <option value="XRPUSD">XRPUSD</option>
                        </select>
                        <button class="btn-add-coin" onclick="promptAddCoin()" data-tooltip="Добавить новую монету"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div class="col-6">
                    <label for="position" class="form-label" data-tooltip="Выберите тип позиции">Позиция</label>
                    <select class="form-select" id="position" required>
                        <option value="Short">Short</option>
                        <option value="Long">Long</option>
                    </select>
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-6">
                    <label for="open_date" class="form-label" data-tooltip="Выберите дату открытия сделки">Дата открытия</label>
                    <div class="input-with-button">
                        <input type="date" class="form-control" id="open_date" required>
                        <i class="fas fa-calendar-alt" onclick="document.getElementById('open_date').showPicker();" data-tooltip="Выбрать дату"></i>
                    </div>
                </div>
                <div class="col-6">
                    <label for="risk" class="form-label" data-tooltip="Введите риск в долларах">Риск на сделку ($)</label>
                    <input type="number" step="0.01" class="form-control" id="risk" required>
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-6">
                    <label for="profit" class="form-label" data-tooltip="Введите прибыль в долларах">Прибыль ($)</label>
                    <input type="number" step="0.01" class="form-control" id="profit" required>
                </div>
                <div class="col-6">
                    <label for="loss" class="form-label" data-tooltip="Введите убыток в долларах">Убыток ($)</label>
                    <input type="number" step="0.01" class="form-control" id="loss" required>
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-6">
                    <label for="result" class="form-label" data-tooltip="Введите итог сделки в процентах">Итог сделки (%)</label>
                    <input type="number" step="0.01" class="form-control" id="result" required>
                </div>
                <div class="col-6">
                    <label for="notes" class="form-label" data-tooltip="Добавьте заметки к сделке">Заметки</label>
                    <div class="input-with-button">
                        <input type="text" class="form-control" id="notes">
                        <button class="btn-add-image" onclick="document.getElementById('notesImage').click()" data-tooltip="Добавить изображение"><i class="fas fa-paperclip"></i></button>
                        <input type="file" class="form-control" id="notesImage" accept="image/*" onchange="handleNotesImageUpload(event)" style="display: none;">
                    </div>
                    <img id="notesImagePreview" class="preview-image" style="display: none;">
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-12">
                    <label for="setup" class="form-label" data-tooltip="Опишите сетап сделки">Сетап</label>
                    <div class="input-with-button">
                        <input type="text" class="form-control" id="setup" required style="height: 80px; resize: vertical;">
                        <button class="btn-add-image" onclick="document.getElementById('setupImage').click()" data-tooltip="Добавить изображение"><i class="fas fa-paperclip"></i></button>
                        <input type="file" class="form-control" id="setupImage" accept="image/*" onchange="handleSetupImageUpload(event)" style="display: none;">
                    </div>
                    <img id="setupImagePreview" class="preview-image" style="display: none;">
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-12">
                    <label for="rating" class="form-label" data-tooltip="Оцените сделку от 1 до 5">Оценка (1-5)</label>
                    <div class="rating-wrapper">
                        <input type="range" class="form-range" id="rating" min="1" max="5" value="1">
                        <div class="rating-track">
                            <div class="rating-fill" id="ratingFill"></div>
                        </div>
                        <div class="rating-value" id="ratingValue">1</div>
                    </div>
                </div>
            </div>
            <button class="btn w-100" id="submitBtn" onclick="saveTrade()" data-tooltip="Сохранить или добавить сделку"><i class="fas fa-plus"></i> Добавить сделку</button>
            <button class="btn w-100 mt-2" id="cancelBtn" style="display: none;" onclick="cancelEdit()" data-tooltip="Отменить редактирование">Отмена</button>
        </div>

        <div id="view" class="card fade-in">
            <h3 class="text-center mb-2" style="font-size: 1.8rem; background: linear-gradient(90deg, #00F7FF, #FF00E6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Мои сделки</h3>
            <div class="progress-bar" id="successProgress"><span>0.00%</span></div>
            <div class="row mb-3">
                <div class="col-6">
                    <label for="filterCoin" class="form-label">Фильтр по монете</label>
                    <select class="form-select" id="filterCoin" onchange="applyFilters()">
                        <option value="">Все</option>
                    </select>
                </div>
                <div class="col-6">
                    <label for="filterDate" class="form-label">Фильтр по дате</label>
                    <div class="input-with-button">
                        <input type="date" class="form-control" id="filterDate" onchange="applyFilters()">
                        <i class="fas fa-calendar-alt" onclick="document.getElementById('filterDate').showPicker();"></i>
                    </div>
                </div>
                <div class="col-6">
                    <label for="filterPosition" class="form-label">Фильтр по позиции</label>
                    <select class="form-select" id="filterPosition" onchange="applyFilters()">
                        <option value="">Все</option>
                        <option value="Short">Short</option>
                        <option value="Long">Long</option>
                    </select>
                </div>
                <div class="col-6">
                    <label for="filterRating" class="form-label">Фильтр по оценке</label>
                    <select class="form-select" id="filterRating" onchange="applyFilters()">
                        <option value="">Все</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
            </div>
            <table class="table table-striped" id="tradesTable">
                <thead>
                    <tr>
                        <th data-sort="id">ID</th>
                        <th data-sort="coin">Монета</th>
                        <th data-sort="position">Позиция</th>
                        <th data-sort="open_date">Дата</th>
                        <th data-sort="risk">Риск ($)</th>
                        <th data-sort="profit">Прибыль ($)</th>
                        <th data-sort="loss">Убыток ($)</th>
                        <th data-sort="result">Итог (%)</th>
                        <th>Сетап</th>
                        <th>Заметки</th>
                        <th data-sort="rating">Оценка</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="tradesBody"></tbody>
            </table>
            <div class="row mt-2">
                <div class="col-6">
                    <button class="btn w-100" onclick="exportToCSV()">Экспорт в CSV</button>
                </div>
                <div class="col-6">
                    <button class="btn w-100" onclick="exportToPDF()">Экспорт в PDF</button>
                </div>
            </div>
        </div>

        <div id="stats" class="stats-container fade-in">
            <h3 class="text-center mb-4">Статистика</h3>
            <div class="stats-grid">
                <div class="stat-card" data-tooltip="Максимальная прибыль за одну сделку">
                    <i class="fas fa-arrow-up stat-icon profit"></i>
                    <h4>Макс. прибыль</h4>
                    <p><span id="maxProfit">0.00</span>$</p>
                </div>
                <div class="stat-card" data-tooltip="Максимальный убыток за одну сделку">
                    <i class="fas fa-arrow-down stat-icon loss"></i>
                    <h4>Макс. убыток</h4>
                    <p><span id="maxLoss">0.00</span>$</p>
                </div>
                <div class="stat-card" data-tooltip="Соотношение лонгов к шортам">
                    <i class="fas fa-balance-scale stat-icon"></i>
                    <h4>Лонги/Шорты</h4>
                    <p><span id="longShortRatio">0/0</span></p>
                </div>
                <div class="stat-card" data-tooltip="Количество прибыльных сделок">
                    <i class="fas fa-check-circle stat-icon profit"></i>
                    <h4>Прибыльных</h4>
                    <p><span id="profitableTrades">0</span></p>
                </div>
                <div class="stat-card" data-tooltip="Количество убыточных сделок">
                    <i class="fas fa-times-circle stat-icon loss"></i>
                    <h4>Убыточных</h4>
                    <p><span id="lossTrades">0</span></p>
                </div>
            </div>
        </div>

        <div id="loadingSpinner" class="spinner" style="display: none;">
            <div class="spinner-circle"></div>
        </div>

        <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="detailModalLabel">Детали</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="detailModalBody">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-action" data-bs-dismiss="modal">Закрыть</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" onclick="showSection('main')"><i class="fas fa-home"></i> Главная</a>
            <a class="navbar-brand active" href="#" onclick="showSection('view')"><i class="fas fa-table"></i> Мои сделки</a>
            <a class="navbar-brand" href="#" onclick="showSection('stats')"><i class="fas fa-chart-bar"></i> Статистика</a>
            <div class="lang-toggle" onclick="toggleLanguageDropdown()">
                <span class="lang-icon">RU</span>
                <i class="fas fa-globe" style="margin-left: 5px;"></i>
                <div class="lang-dropdown">
                    <div class="lang-option" data-lang="ru">RU</div>
                    <div class="lang-option" data-lang="en">EN</div>
                </div>
            </div>
        </div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let trades = JSON.parse(localStorage.getItem("trades")) || [];
        let coins = JSON.parse(localStorage.getItem("coins")) || ["BTCUSD", "ETHUSD", "XRPUSD"];
        let images = JSON.parse(localStorage.getItem("images")) || {};
        let editingTradeId = null;
        let filters = JSON.parse(localStorage.getItem("filters")) || { coin: "", position: "", date: "", rating: "" };
        let sortColumn = null;
        let sortDirection = 1;
        let currentLanguage = "ru";

        const translations = {
            ru: {
                title: "Дневник трейдера",
                mainSection: "Главная",
                viewSection: "Мои сделки",
                statsSection: "Статистика",
                coinLabel: "Монета",
                positionLabel: "Позиция",
                openDateLabel: "Дата",
                riskLabel: "Риск ($)",
                profitLabel: "Прибыль ($)",
                lossLabel: "Убыток ($)",
                resultLabel: "Итог (%)",
                notesLabel: "Заметки",
                setupLabel: "Сетап",
                ratingLabel: "Оценка",
                addTradeButton: "Добавить сделку",
                cancelButton: "Отмена",
                filterCoinLabel: "Фильтр по монете",
                filterDateLabel: "Фильтр по дате",
                filterPositionLabel: "Фильтр по позиции",
                filterRatingLabel: "Фильтр по оценке",
                allOption: "Все",
                shortOption: "Short",
                longOption: "Long",
                exportCSVButton: "Экспорт в CSV",
                exportPDFButton: "Экспорт в PDF",
                detailsLabel: "Детали",
                setupDetails: "Сетап",
                notesDetails: "Заметки",
                closeButton: "Закрыть",
                deleteConfirm: "Удалить сделку с ID",
                addCoinPrompt: "Введите название новой монеты:",
                coinExistsAlert: "Монета уже существует!",
                emptyCoinAlert: "Название монеты не может быть пустым!",
                tradeAddedAlert: "Сделка добавлена!",
                tradeUpdatedAlert: "Сделка обновлена!",
                tradeDeletedAlert: "Сделка удалена!",
                noTradesAlert: "Нет сделок для экспорта!",
                requiredFieldAlert: "Поле",
                negativeValueAlert: "не может быть отрицательным!",
                maxProfitLabel: "Макс. прибыль",
                maxLossLabel: "Макс. убыток",
                longShortRatioLabel: "Лонги/Шорты",
                profitableTradesLabel: "Прибыльных",
                lossTradesLabel: "Убыточных",
                editButton: "Ред.",
                deleteButton: "Удал.",
                actionLabel: "Действия",
                detailsButton: "Подробнее",
                tooltipSelectCoin: "Выберите или добавьте монету",
                tooltipSelectPosition: "Выберите тип позиции",
                tooltipSelectDate: "Выберите дату открытия сделки",
                tooltipEnterRisk: "Введите риск в долларах",
                tooltipEnterProfit: "Введите прибыль в долларах",
                tooltipEnterLoss: "Введите убыток в долларах",
                tooltipEnterResult: "Введите итог сделки в процентах",
                tooltipAddNotes: "Добавьте заметки к сделке",
                tooltipDescribeSetup: "Опишите сетап сделки",
                tooltipRateTrade: "Оцените сделку от 1 до 5",
                tooltipAddTrade: "Сохранить или добавить сделку",
                tooltipCancelEdit: "Отменить редактирование",
                tooltipAddNewCoin: "Добавить новую монету",
                tooltipAddImage: "Добавить изображение",
                tooltipMaxProfit: "Максимальная прибыль за одну сделку",
                tooltipMaxLoss: "Максимальный убыток за одну сделку",
                tooltipLongShortRatio: "Соотношение лонгов к шортам",
                tooltipProfitableTrades: "Количество прибыльных сделок",
                tooltipLossTrades: "Количество убыточных сделок"
            },
            en: {
                title: "Trader's Journal",
                mainSection: "Main",
                viewSection: "My Trades",
                statsSection: "Statistics",
                coinLabel: "Coin",
                positionLabel: "Position",
                openDateLabel: "Open Date",
                riskLabel: "Risk ($)",
                profitLabel: "Profit ($)",
                lossLabel: "Loss ($)",
                resultLabel: "Result (%)",
                notesLabel: "Notes",
                setupLabel: "Setup",
                ratingLabel: "Rating",
                addTradeButton: "Add Trade",
                cancelButton: "Cancel",
                filterCoinLabel: "Filter by Coin",
                filterDateLabel: "Filter by Date",
                filterPositionLabel: "Filter by Position",
                filterRatingLabel: "Filter by Rating",
                allOption: "All",
                shortOption: "Short",
                longOption: "Long",
                exportCSVButton: "Export to CSV",
                exportPDFButton: "Export to PDF",
                detailsLabel: "Details",
                setupDetails: "Setup",
                notesDetails: "Notes",
                closeButton: "Close",
                deleteConfirm: "Delete trade with ID",
                addCoinPrompt: "Enter the name of a new coin:",
                coinExistsAlert: "Coin already exists!",
                emptyCoinAlert: "Coin name cannot be empty!",
                tradeAddedAlert: "Trade added!",
                tradeUpdatedAlert: "Trade updated!",
                tradeDeletedAlert: "Trade deleted!",
                noTradesAlert: "No trades to export!",
                requiredFieldAlert: "Field",
                negativeValueAlert: "cannot be negative!",
                maxProfitLabel: "Max Profit",
                maxLossLabel: "Max Loss",
                longShortRatioLabel: "Longs/Shorts",
                profitableTradesLabel: "Profitable",
                lossTradesLabel: "Loss-making",
                editButton: "Edit",
                deleteButton: "Delete",
                actionLabel: "Actions",
                detailsButton: "Details",
                tooltipSelectCoin: "Select or add a coin",
                tooltipSelectPosition: "Select position type",
                tooltipSelectDate: "Select trade opening date",
                tooltipEnterRisk: "Enter risk in dollars",
                tooltipEnterProfit: "Enter profit in dollars",
                tooltipEnterLoss: "Enter loss in dollars",
                tooltipEnterResult: "Enter trade result in percentage",
                tooltipAddNotes: "Add notes to the trade",
                tooltipDescribeSetup: "Describe the trade setup",
                tooltipRateTrade: "Rate the trade from 1 to 5",
                tooltipAddTrade: "Save or add trade",
                tooltipCancelEdit: "Cancel editing",
                tooltipAddNewCoin: "Add a new coin",
                tooltipAddImage: "Add an image",
                tooltipMaxProfit: "Maximum profit per trade",
                tooltipMaxLoss: "Maximum loss per trade",
                tooltipLongShortRatio: "Long/Short ratio",
                tooltipProfitableTrades: "Number of profitable trades",
                tooltipLossTrades: "Number of loss-making trades"
            }
        };

        function compressImage(file, callback) {
            if (!file.type.startsWith("image/")) {
                alert(translations[currentLanguage].noTradesAlert);
                return;
            }
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");
                    const maxWidth = 800;
                    const maxHeight = 600;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = Math.round((width * maxHeight) / height);
                            height = maxHeight;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    const compressedImage = canvas.toDataURL("image/jpeg", 0.7);
                    callback(compressedImage);
                };
            };
        }

        function handleSetupImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                compressImage(file, compressedImage => {
                    images["setupImage"] = compressedImage;
                    localStorage.setItem("images", JSON.stringify(images));
                    document.getElementById("setupImagePreview").src = compressedImage;
                    document.getElementById("setupImagePreview").style.display = "block";
                });
            }
        }

        function handleNotesImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                compressImage(file, compressedImage => {
                    images["notesImage"] = compressedImage;
                    localStorage.setItem("images", JSON.stringify(images));
                    document.getElementById("notesImagePreview").src = compressedImage;
                    document.getElementById("notesImagePreview").style.display = "block";
                });
            }
        }

        function promptAddCoin() {
            const newCoin = prompt(translations[currentLanguage].addCoinPrompt);
            if (newCoin && newCoin.trim() && !coins.includes(newCoin.trim())) {
                coins.push(newCoin.trim());
                localStorage.setItem("coins", JSON.stringify(coins));
                updateCoinSelect();
                updateFilterCoinOptions();
                alert(translations[currentLanguage].tradeAddedAlert);
            } else if (newCoin && coins.includes(newCoin.trim())) {
                alert(translations[currentLanguage].coinExistsAlert);
            } else {
                alert(translations[currentLanguage].emptyCoinAlert);
            }
        }

        function updateCoinSelect() {
            const select = document.getElementById("coin");
            select.innerHTML = "";
            coins.forEach(coin => {
                const option = document.createElement("option");
                option.value = coin;
                option.textContent = coin;
                select.appendChild(option);
            });
        }

        function updateFilterCoinOptions() {
            const filterCoin = document.getElementById("filterCoin");
            filterCoin.innerHTML = `<option value="">${translations[currentLanguage].allOption}</option>`;
            coins.forEach(coin => {
                const option = document.createElement("option");
                option.value = coin;
                option.textContent = coin;
                filterCoin.appendChild(option);
            });
            filterCoin.value = filters.coin;
        }

        function applyFilters() {
            filters.coin = document.getElementById("filterCoin").value;
            filters.position = document.getElementById("filterPosition").value;
            filters.date = document.getElementById("filterDate").value;
            filters.rating = document.getElementById("filterRating").value;
            localStorage.setItem("filters", JSON.stringify(filters));
            updateTable();
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${year}-${month}-${day}`; // Формат для input type="date" (YYYY-MM-DD)
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection *= -1;
            } else {
                sortColumn = column;
                sortDirection = 1;
            }
            trades.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];
                if (column === "open_date") {
                    valA = new Date(a[column]);
                    valB = new Date(b[column]);
                } else if (["risk", "profit", "loss", "result", "rating"].includes(column)) {
                    valA = parseFloat(a[column]);
                    valB = parseFloat(b[column]);
                }
                return valA > valB ? sortDirection : valA < valB ? -sortDirection : 0;
            });
            localStorage.setItem("trades", JSON.stringify(trades));
            updateTable();
        }

        function validateForm() {
            const requiredFields = ["coin", "position", "open_date", "risk", "profit", "loss", "result", "setup"];
            for (let field of requiredFields) {
                const value = document.getElementById(field).value.trim();
                if (!value) {
                    alert(`${translations[currentLanguage].requiredFieldAlert} "${document.querySelector(`label[for="${field}"]`).textContent}" ${translations[currentLanguage].requiredFieldAlert}!`);
                    return false;
                }
            }

            const numericFields = ["risk", "profit", "loss"];
            for (let field of numericFields) {
                const value = parseFloat(document.getElementById(field).value);
                if (value < 0) {
                    alert(`${document.querySelector(`label[for="${field}"]`).textContent} ${translations[currentLanguage].negativeValueAlert}`);
                    return false;
                }
            }

            return true;
        }

        function editTrade(id) {
            const trade = trades.find(t => t.id === id);
            if (trade) {
                editingTradeId = id;
                document.getElementById("coin").value = trade.coin;
                document.getElementById("position").value = trade.position;
                document.getElementById("open_date").value = trade.open_date; // Уже в формате YYYY-MM-DD
                document.getElementById("risk").value = trade.risk;
                document.getElementById("profit").value = trade.profit;
                document.getElementById("loss").value = trade.loss;
                document.getElementById("result").value = trade.result;
                document.getElementById("setup").value = trade.setup;
                document.getElementById("notes").value = trade.notes || "";
                document.getElementById("rating").value = trade.rating;
                document.getElementById("ratingValue").textContent = trade.rating;
                document.getElementById("setupImage").value = "";
                document.getElementById("notesImage").value = "";
                images = {
                    "setupImage": trade.setupImage || "",
                    "notesImage": trade.notesImage || ""
                };
                localStorage.setItem("images", JSON.stringify(images));
                if (trade.setupImage) {
                    document.getElementById("setupImagePreview").src = trade.setupImage;
                    document.getElementById("setupImagePreview").style.display = "block";
                }
                if (trade.notesImage) {
                    document.getElementById("notesImagePreview").src = trade.notesImage;
                    document.getElementById("notesImagePreview").style.display = "block";
                }

                document.getElementById("submitBtn").textContent = translations[currentLanguage].addTradeButton;
                document.getElementById("cancelBtn").style.display = "block";
                updateRatingDisplay(); // Обновляем ползунок рейтинга при редактировании
                showSection('main');
            }
        }

        function showSpinner() {
            document.getElementById('loadingSpinner').style.display = 'flex';
        }

        function hideSpinner() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }

        function saveTrade() {
            if (!validateForm()) return;

            showSpinner();

            setTimeout(() => {
                if (editingTradeId) {
                    const tradeIndex = trades.findIndex(t => t.id === editingTradeId);
                    if (tradeIndex !== -1) {
                        const updatedTrade = {
                            id: editingTradeId,
                            coin: document.getElementById("coin").value,
                            position: document.getElementById("position").value,
                            open_date: document.getElementById("open_date").value,
                            risk: parseFloat(document.getElementById("risk").value) || 0,
                            profit: parseFloat(document.getElementById("profit").value) || 0,
                            loss: parseFloat(document.getElementById("loss").value) || 0,
                            result: parseFloat(document.getElementById("result").value) || 0,
                            setup: document.getElementById("setup").value,
                            notes: document.getElementById("notes").value,
                            rating: parseInt(document.getElementById("rating").value) || 1,
                            setupImage: images["setupImage"] || "",
                            notesImage: images["notesImage"] || ""
                        };
                        trades[tradeIndex] = updatedTrade;
                        localStorage.setItem("trades", JSON.stringify(trades));
                        alert(translations[currentLanguage].tradeUpdatedAlert);
                    }
                    editingTradeId = null;
                    document.getElementById("submitBtn").textContent = translations[currentLanguage].addTradeButton;
                    document.getElementById("cancelBtn").style.display = "none";
                } else {
                    const trade = {
                        id: trades.length + 1,
                        coin: document.getElementById("coin").value,
                        position: document.getElementById("position").value,
                        open_date: document.getElementById("open_date").value,
                        risk: parseFloat(document.getElementById("risk").value) || 0,
                        profit: parseFloat(document.getElementById("profit").value) || 0,
                        loss: parseFloat(document.getElementById("loss").value) || 0,
                        result: parseFloat(document.getElementById("result").value) || 0,
                        setup: document.getElementById("setup").value,
                        notes: document.getElementById("notes").value,
                        rating: parseInt(document.getElementById("rating").value) || 1,
                        setupImage: images["setupImage"] || "",
                        notesImage: images["notesImage"] || ""
                    };
                    trades.push(trade);
                    localStorage.setItem("trades", JSON.stringify(trades));
                    alert(translations[currentLanguage].tradeAddedAlert);
                }
                clearForm();
                updateTable();
                updateStats();
                autoSave();
                hideSpinner();
            }, 1000);
        }

        function cancelEdit() {
            editingTradeId = null;
            clearForm();
            document.getElementById("submitBtn").textContent = translations[currentLanguage].addTradeButton;
            document.getElementById("cancelBtn").style.display = "none";
            showSection('main');
        }

        function clearForm() {
            document.getElementById("coin").value = "BTCUSD";
            document.getElementById("position").value = "Short";
            document.getElementById("open_date").value = formatDate(new Date()); // Устанавливаем текущую дату в формате YYYY-MM-DD
            document.getElementById("risk").value = "";
            document.getElementById("profit").value = "";
            document.getElementById("loss").value = "";
            document.getElementById("result").value = "";
            document.getElementById("setup").value = "";
            document.getElementById("notes").value = "";
            document.getElementById("rating").value = "1";
            document.getElementById("ratingValue").textContent = "1";
            document.getElementById("setupImage").value = "";
            document.getElementById("notesImage").value = "";
            document.getElementById("setupImagePreview").style.display = "none";
            document.getElementById("notesImagePreview").style.display = "none";
            images = {};
            localStorage.setItem("images", JSON.stringify(images));
            updateRatingDisplay(); // Обновляем ползунок рейтинга при очистке формы
        }

        function updateTable() {
            const tbody = document.getElementById("tradesBody");
            tbody.innerHTML = "";
            const filteredTrades = trades.filter(trade => {
                const matchesCoin = filters.coin ? trade.coin === filters.coin : true;
                const matchesPosition = filters.position ? trade.position === filters.position : true;
                const matchesDate = filters.date ? trade.open_date === filters.date : true;
                const matchesRating = filters.rating ? Math.floor(trade.rating) === parseInt(filters.rating) : true;
                return matchesCoin && matchesPosition && matchesDate && matchesRating;
            });
            filteredTrades.forEach(trade => {
                const row = document.createElement("tr");
                row.classList.add("fade-in");
                row.innerHTML = `
                    <td>${trade.id}</td>
                    <td>${trade.coin}</td>
                    <td>${trade.position}</td>
                    <td>${formatDate(trade.open_date)}</td>
                    <td>${trade.risk.toFixed(2)}</td>
                    <td>${trade.profit.toFixed(2)}</td>
                    <td>${trade.loss.toFixed(2)}</td>
                    <td>${trade.result.toFixed(2)}</td>
                    <td class="setup-cell"><button class="btn-action btn-sm" onclick="showDetailModal(${trade.id}, 'setup')">${translations[currentLanguage].detailsButton}</button></td>
                    <td class="notes-cell"><button class="btn-action btn-sm" onclick="showDetailModal(${trade.id}, 'notes')">${translations[currentLanguage].detailsButton}</button></td>
                    <td>${trade.rating}</td>
                    <td>
                        <button class="btn-action btn-sm" onclick="editTrade(${trade.id})">${translations[currentLanguage].editButton}</button>
                        <button class="btn-action btn-sm" onclick="deleteTrade(${trade.id})">${translations[currentLanguage].deleteButton}</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            updateProgressBar();
        }

        function updateProgressBar() {
            const successRate = trades.length > 0 ? (trades.filter(t => t.result > 0).length / trades.length * 100).toFixed(2) : 0;
            const progressBar = document.getElementById("successProgress");
            progressBar.style.width = `${successRate}%`;
            progressBar.firstChild.textContent = `${successRate}%`;
        }

        function showDetailModal(id, type) {
            const trade = trades.find(t => t.id === id);
            if (trade) {
                const modalBody = document.getElementById("detailModalBody");
                let content = "";
                if (type === 'setup') {
                    content = trade.setup || "No setup information available.";
                    if (trade.setupImage) {
                        content += `<img src="${trade.setupImage}" alt="Setup Image" style="max-width: 100%; margin-top: 10px;">`;
                    }
                } else if (type === 'notes') {
                    content = trade.notes || "No notes available.";
                    if (trade.notesImage) {
                        content += `<img src="${trade.notesImage}" alt="Notes Image" style="max-width: 100%; margin-top: 10px;">`;
                    }
                }
                modalBody.innerHTML = `<p>${content}</p>`;
                document.getElementById("detailModalLabel").textContent = `${translations[currentLanguage].detailsLabel} ${type === 'setup' ? translations[currentLanguage].setupDetails : translations[currentLanguage].notesDetails}`;
                new bootstrap.Modal(document.getElementById('detailModal')).show();
            }
        }

        function deleteTrade(id) {
            if (confirm(`${translations[currentLanguage].deleteConfirm} ${id}?`)) {
                trades = trades.filter(t => t.id !== id);
                trades = trades.map((trade, index) => ({ ...trade, id: index + 1 }));
                localStorage.setItem("trades", JSON.stringify(trades));
                updateTable();
                updateStats();
                alert(translations[currentLanguage].tradeDeletedAlert);
            }
        }

        function exportToCSV() {
            if (trades.length === 0) {
                alert(translations[currentLanguage].noTradesAlert);
                return;
            }
            showSpinner();
            setTimeout(() => {
                let csv = "ID,Coin,Position,Date,Risk,Profit,Loss,Result,Setup,Notes,Rating\n";
                trades.forEach(trade => {
                    csv += `${trade.id},${trade.coin},${trade.position},${trade.open_date},${trade.risk},${trade.profit},${trade.loss},${trade.result},${trade.setup},${trade.notes || ''},${trade.rating}\n`;
                });
                const blob = new Blob([csv], { type: "text/csv" });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "trading_journal.csv";
                a.click();
                window.URL.revokeObjectURL(url);
                hideSpinner();
            }, 1000);
        }

        function exportToPDF() {
            showSpinner();
            setTimeout(() => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text("Trader's Journal", 10, 10);
                let y = 20;
                doc.setFontSize(12);
                trades.forEach(trade => {
                    doc.text(`ID: ${trade.id}, Coin: ${trade.coin}, Position: ${trade.position}, Date: ${formatDate(trade.open_date)}, Risk: ${trade.risk}$, Profit: ${trade.profit}$, Loss: ${trade.loss}$, Result: ${trade.result}%, Setup: ${trade.setup}, Notes: ${trade.notes || ''}, Rating: ${trade.rating}`, 10, y);
                    y += 10;
                    if (y > 280) {
                        doc.addPage();
                        y = 10;
                    }
                });
                doc.save("trading_journal.pdf");
                hideSpinner();
            }, 1000);
        }

        function updateStats() {
            if (trades.length === 0) {
                document.getElementById("maxProfit").textContent = "0.00";
                document.getElementById("maxLoss").textContent = "0.00";
                document.getElementById("longShortRatio").textContent = "0/0";
                document.getElementById("profitableTrades").textContent = "0";
                document.getElementById("lossTrades").textContent = "0";
                return;
            }

            const maxProfit = Math.max(...trades.map(t => t.profit));
            document.getElementById("maxProfit").textContent = maxProfit.toFixed(2);

            const maxLoss = Math.max(...trades.map(t => t.loss));
            document.getElementById("maxLoss").textContent = maxLoss.toFixed(2);

            const longCount = trades.filter(t => t.position === "Long").length;
            const shortCount = trades.filter(t => t.position === "Short").length;
            document.getElementById("longShortRatio").textContent = `${longCount}/${shortCount}`;

            const profitableTrades = trades.filter(t => t.result > 0).length;
            const lossTrades = trades.filter(t => t.result < 0).length;
            document.getElementById("profitableTrades").textContent = profitableTrades;
            document.getElementById("lossTrades").textContent = lossTrades;
        }

        function showSection(section) {
            const sections = ['main', 'view', 'stats'];
            sections.forEach(s => {
                const element = document.querySelector(`#${s}`);
                if (element) element.style.display = s === section ? 'block' : 'none';
            });
            if (section === 'main' && !editingTradeId) clearForm();
            if (section === 'view') {
                updateTable();
                updateFilterCoinOptions();
                document.querySelectorAll('#tradesTable th[data-sort]').forEach(th => {
                    th.addEventListener('click', () => sortTable(th.getAttribute('data-sort')));
                });
            }
            if (section === 'stats') updateStats();
            document.querySelectorAll('.navbar-brand').forEach(a => a.classList.remove('active'));
            document.querySelector(`.navbar-brand[onclick="showSection('${section}')"]`).classList.add('active');
            translateInterface();
        }

        function toggleLanguageDropdown() {
            const dropdown = document.querySelector('.lang-dropdown');
            dropdown.classList.toggle('active');
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem("language", lang);
            translateInterface();
            document.querySelector('.lang-icon').textContent = lang.toUpperCase();
            document.querySelector('.lang-dropdown').classList.remove('active');
            // Обновляем таблицу и фильтры после смены языка
            updateTable();
            updateFilterCoinOptions();
        }

        function translateInterface() {
            document.querySelector('h1').textContent = translations[currentLanguage].title;
            document.querySelectorAll('.navbar-brand')[0].innerHTML = `<i class="fas fa-home"></i> ${translations[currentLanguage].mainSection}`;
            document.querySelectorAll('.navbar-brand')[1].innerHTML = `<i class="fas fa-table"></i> ${translations[currentLanguage].viewSection}`;
            document.querySelectorAll('.navbar-brand')[2].innerHTML = `<i class="fas fa-chart-bar"></i> ${translations[currentLanguage].statsSection}`;
            document.querySelector('#view h3').textContent = translations[currentLanguage].viewSection;
            document.querySelector('#stats h3').textContent = translations[currentLanguage].statsSection;
            document.querySelector('label[for="coin"]').textContent = translations[currentLanguage].coinLabel;
            document.querySelector('label[for="position"]').textContent = translations[currentLanguage].positionLabel;
            document.querySelector('label[for="open_date"]').textContent = translations[currentLanguage].openDateLabel;
            document.querySelector('label[for="risk"]').textContent = translations[currentLanguage].riskLabel;
            document.querySelector('label[for="profit"]').textContent = translations[currentLanguage].profitLabel;
            document.querySelector('label[for="loss"]').textContent = translations[currentLanguage].lossLabel;
            document.querySelector('label[for="result"]').textContent = translations[currentLanguage].resultLabel;
            document.querySelector('label[for="notes"]').textContent = translations[currentLanguage].notesLabel;
            document.querySelector('label[for="setup"]').textContent = translations[currentLanguage].setupLabel;
            document.querySelector('label[for="rating"]').textContent = translations[currentLanguage].ratingLabel;
            document.getElementById("submitBtn").textContent = translations[currentLanguage].addTradeButton;
            document.getElementById("cancelBtn").textContent = translations[currentLanguage].cancelButton;
            document.querySelector('label[for="filterCoin"]').textContent = translations[currentLanguage].filterCoinLabel;
            document.querySelector('label[for="filterDate"]').textContent = translations[currentLanguage].filterDateLabel;
            document.querySelector('label[for="filterPosition"]').textContent = translations[currentLanguage].filterPositionLabel;
            document.querySelector('label[for="filterRating"]').textContent = translations[currentLanguage].filterRatingLabel;
            document.querySelector('#filterCoin option[value=""]').textContent = translations[currentLanguage].allOption;
            document.querySelector('#filterPosition option[value=""]').textContent = translations[currentLanguage].allOption;
            document.querySelector('#filterPosition option[value="Short"]').textContent = translations[currentLanguage].shortOption;
            document.querySelector('#filterPosition option[value="Long"]').textContent = translations[currentLanguage].longOption;
            document.querySelectorAll('.row.mt-2 .col-6 button')[0].textContent = translations[currentLanguage].exportCSVButton;
            document.querySelectorAll('.row.mt-2 .col-6 button')[1].textContent = translations[currentLanguage].exportPDFButton;
            document.querySelector('#detailModalLabel').textContent = translations[currentLanguage].detailsLabel;
            document.querySelector('.modal-footer .btn-action').textContent = translations[currentLanguage].closeButton;
            document.querySelectorAll('.stat-card h4')[0].textContent = translations[currentLanguage].maxProfitLabel;
            document.querySelectorAll('.stat-card h4')[1].textContent = translations[currentLanguage].maxLossLabel;
            document.querySelectorAll('.stat-card h4')[2].textContent = translations[currentLanguage].longShortRatioLabel;
            document.querySelectorAll('.stat-card h4')[3].textContent = translations[currentLanguage].profitableTradesLabel;
            document.querySelectorAll('.stat-card h4')[4].textContent = translations[currentLanguage].lossTradesLabel;

            document.querySelectorAll('.table th')[0].textContent = "ID";
            document.querySelectorAll('.table th')[1].textContent = translations[currentLanguage].coinLabel;
            document.querySelectorAll('.table th')[2].textContent = translations[currentLanguage].positionLabel;
            document.querySelectorAll('.table th')[3].textContent = translations[currentLanguage].openDateLabel;
            document.querySelectorAll('.table th')[4].textContent = translations[currentLanguage].riskLabel;
            document.querySelectorAll('.table th')[5].textContent = translations[currentLanguage].profitLabel;
            document.querySelectorAll('.table th')[6].textContent = translations[currentLanguage].lossLabel;
            document.querySelectorAll('.table th')[7].textContent = translations[currentLanguage].resultLabel;
            document.querySelectorAll('.table th')[8].textContent = translations[currentLanguage].setupLabel;
            document.querySelectorAll('.table th')[9].textContent = translations[currentLanguage].notesLabel;
            document.querySelectorAll('.table th')[10].textContent = translations[currentLanguage].ratingLabel;
            document.querySelectorAll('.table th')[11].textContent = translations[currentLanguage].actionLabel;

            document.querySelector('label[for="coin"]').setAttribute("data-tooltip", translations[currentLanguage].tooltipSelectCoin);
            document.querySelector('label[for="position"]').setAttribute("data-tooltip", translations[currentLanguage].tooltipSelectPosition);
            document.querySelector('label[for="open_date"]').setAttribute("data-tooltip", translations[currentLanguage].tooltipSelectDate);
            document.querySelector('label[for="risk"]').setAttribute("data-tooltip", translations[currentLanguage].tooltipEnterRisk);
            document.querySelector('label[for="profit"]').setAttribute("data-tooltip", translations[currentLanguage].tooltipEnterProfit);
            document.querySelector('label[for="loss"]').setAttribute("data-tooltip", translations[currentLanguage].tooltipEnterLoss);
            document.querySelector('label[for="result"]').setAttribute("data-tooltip", translations[currentLanguage].tooltipEnterResult);
            document.querySelector('label[for="notes"]').setAttribute("data-tooltip", translations[currentLanguage].tooltipAddNotes);
            document.querySelector('label[for="setup"]').setAttribute("data-tooltip", translations[currentLanguage].tooltipDescribeSetup);
            document.querySelector('label[for="rating"]').setAttribute("data-tooltip", translations[currentLanguage].tooltipRateTrade);
            document.getElementById("submitBtn").setAttribute("data-tooltip", translations[currentLanguage].tooltipAddTrade);
            document.getElementById("cancelBtn").setAttribute("data-tooltip", translations[currentLanguage].tooltipCancelEdit);
            document.querySelector('.btn-add-coin').setAttribute("data-tooltip", translations[currentLanguage].tooltipAddNewCoin);
            document.querySelectorAll('.btn-add-image').forEach(btn => btn.setAttribute("data-tooltip", translations[currentLanguage].tooltipAddImage));
            document.querySelectorAll('.stat-card')[0].setAttribute("data-tooltip", translations[currentLanguage].tooltipMaxProfit);
            document.querySelectorAll('.stat-card')[1].setAttribute("data-tooltip", translations[currentLanguage].tooltipMaxLoss);
            document.querySelectorAll('.stat-card')[2].setAttribute("data-tooltip", translations[currentLanguage].tooltipLongShortRatio);
            document.querySelectorAll('.stat-card')[3].setAttribute("data-tooltip", translations[currentLanguage].tooltipProfitableTrades);
            document.querySelectorAll('.stat-card')[4].setAttribute("data-tooltip", translations[currentLanguage].tooltipLossTrades);
        }

        function autoSave() {
            setTimeout(() => {
                localStorage.setItem("trades", JSON.stringify(trades));
                localStorage.setItem("coins", JSON.stringify(coins));
                localStorage.setItem("images", JSON.stringify(images));
                localStorage.setItem("filters", JSON.stringify(filters));
            }, 1000);
        }

        function updateRatingDisplay() {
            const ratingInput = document.getElementById("rating");
            const ratingValue = document.getElementById("ratingValue");
            const ratingFill = document.getElementById("ratingFill");
            let value = parseFloat(ratingInput.value);
            
            const roundedValue = Math.round(value);
            ratingValue.textContent = roundedValue;
            
            const percentage = ((roundedValue - 1) / 4) * 100;
            ratingFill.style.width = `${percentage}%`;
            
            // Принудительно устанавливаем градиент для совместимости
            ratingFill.style.background = `linear-gradient(90deg, #00F7FF, #FF00E6)`;
        }

        // Привязываем обновление к событиям ползунка
        document.getElementById("rating").addEventListener("input", updateRatingDisplay);

        // Инициализация при загрузке
        updateRatingDisplay();

        // Initialize the application
        document.addEventListener("DOMContentLoaded", () => {
            updateCoinSelect();
            updateFilterCoinOptions();
            showSection('view');
            if (localStorage.getItem("language")) {
                setLanguage(localStorage.getItem("language"));
            }
            document.querySelectorAll('.lang-option').forEach(option => {
                option.addEventListener('click', () => setLanguage(option.getAttribute('data-lang')));
            });
            updateTable();
            updateStats();
        });
    </script>
</body>
</html>
