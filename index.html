<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дневник трейдера</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: linear-gradient(135deg, #1E2A44 0%, #0F172A 100%);
            color: #ECF0F1;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: fadeIn 1.5s ease-in-out;
        }
        .card {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 247, 255, 0.2);
        }
        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #FFFFFF;
            border-radius: 5px;
            transition: all 0.3s ease;
            height: 40px;
        }
        .form-control:focus, .form-select:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: #00F7FF;
            box-shadow: 0 0 5px rgba(0, 247, 255, 0.5);
            color: #FFFFFF;
        }
        .form-select option {
            background: #1E2A44;
            color: #FFFFFF;
        }
        .form-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            color: #A0B1C5;
        }
        .btn {
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
            box-shadow: 0 0 5px rgba(0, 247, 255, 0.5);
        }
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0, 247, 255, 0.8);
        }
        .btn-action {
            background: #1E2A44;
            color: #00F7FF;
            border: 1px solid #00F7FF;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.8rem;
            margin: 0 2px;
            transition: all 0.3s ease;
        }
        .btn-action:hover {
            background: #00F7FF;
            color: #1E2A44;
            box-shadow: 0 0 5px #00F7FF;
        }
        .btn-add-coin {
            background: #00F7FF;
            color: #1E2A44;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 1rem;
            margin-left: 5px;
            transition: all 0.3s ease;
        }
        .btn-add-coin:hover {
            background: #FF00E6;
            color: #FFFFFF;
            box-shadow: 0 0 5px #FF00E6;
        }
        .btn-add-image {
            position: absolute;
            right: 27px;
            top: 50%;
            transform: translateY(-0%);
            background: rgba(0, 195, 255, 0.692);
            border: none;
            border-radius: 35px;
            padding: 3px 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-add-image:hover {
            background: #00F7FF;
            color: #1E2A44;
        }
        .btn-add-image i {
            font-size: 0.9rem;
        }
        .table {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 10px;
            overflow: hidden;
            width: 100%;
            display: block;
            overflow-x: auto;
        }
        .table th {
            background: rgba(255, 255, 255, 0.1);
            color: #00F7FF;
            text-transform: uppercase;
            font-size: 0.9rem;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            text-align: center;
            padding: 8px;
            cursor: pointer;
        }
        .table th:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .table td {
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #FFFFFF;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            text-align: center;
            padding: 8px;
            max-width: 150px;
        }
        .image-icon-container {
            margin-top: 5px;
        }
        .image-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            object-fit: cover;
            border-radius: 4px;
            transition: transform 0.3s ease;
        }
        .image-icon:hover {
            transform: scale(1.2);
        }
        .modal-image {
            max-width: 100%;
            max-height: 80vh;
            display: block;
            margin: 0 auto;
            border-radius: 5px;
        }
        .modal-content {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ECF0F1;
        }
        .modal-header, .modal-footer {
            background: rgba(15, 23, 42, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            border-top: none;
        }
        .modal-body {
            background: rgba(15, 23, 42, 0.9);
            padding: 15px;
        }
        @media (min-width: 969px) {
            .table {
                display: table;
                overflow-x: visible;
                width: 100%;
                margin-left: 0;
                margin-right: 0;
            }
            #view .col-6 .form-select,
            #view .col-6 .form-control {
                width: 220px;
            }
            #view .col-6 .input-with-button {
                position: relative;
                width: 220px;
            }
            #view .col-6 .input-with-button .fas.fa-calendar-alt {
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                color: #A0B1C5;
                cursor: pointer;
            }
        }
        #view .row.mb-3 {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        .navbar {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px 0;
            position: fixed;
            bottom: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .navbar-brand {
            color: #ECF0F1;
            font-size: 1.1rem;
            padding: 10px 15px;
            border-radius: 5px;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            align-items: center;
            text-decoration: none;
        }
        .navbar-brand i {
            margin-right: 8px;
        }
        .navbar-brand:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #00F7FF;
            box-shadow: 0 0 5px rgba(0, 247, 255, 0.5);
        }
        .lang-toggle {
            position: relative;
            padding: 10px 15px;
            border-radius: 5px;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .lang-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #00F7FF;
            box-shadow: 0 0 5px rgba(0, 247, 255, 0.5);
        }
        .lang-icon {
            font-weight: bold;
            color: #00F7FF;
            margin-right: 5px;
        }
        .lang-dropdown {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 5px 0;
            min-width: 80px;
            box-shadow: 0 0 10px rgba(0, 247, 255, 0.3);
            z-index: 1000;
            animation: slideDown 0.3s ease-out;
        }
        .lang-dropdown.active {
            display: block;
        }
        .lang-option {
            color: #ECF0F1;
            padding: 5px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .lang-option:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #00F7FF;
        }
        .spinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .spinner-circle {
            width: 50px;
            height: 50px;
            border: 5px solid #00F7FF;
            border-top: 5px solid #FF00E6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .stats-container {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(15px);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 60px;
        }
        .stats-container h3 {
            color: #00F7FF;
            font-size: 1.8rem;
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            justify-items: center;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            width: 100%;
            max-width: 200px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: float 3s ease-in-out infinite;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 15px rgba(0, 247, 255, 0.5);
        }
        .stat-card h4 {
            color: #A0B1C5;
            font-size: 1rem;
            margin: 10px 0 5px;
            text-transform: uppercase;
        }
        .stat-card p {
            margin: 0;
            font-size: 1.2rem;
            color: #FFFFFF;
        }
        .stat-card span {
            color: #00F7FF;
            font-weight: bold;
            font-size: 1.3rem;
        }
        .stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .stat-icon.profit {
            color: #00F7FF;
        }
        .stat-icon.loss {
            color: #FF00E6;
        }
        @keyframes float {
            0% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0); }
        }
        .progress-bar {
            width: 0;
            height: 20px;
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            color: #1E2A44;
            font-weight: bold;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .progress-bar span {
            line-height: 20px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            color: #FFFFFF;
        }
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]:hover:after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            color: #1E2A44;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 0 5px rgba(0, 247, 255, 0.5);
            pointer-events: none;
        }
        #view [data-tooltip]:hover:after {
            display: none;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        .input-with-button {
            position: relative;
            display: flex;
            align-items: center;
        }
        .input-with-button .form-control {
            padding-right: 30px;
            width: 100%;
        }
        .input-with-button .fas.fa-calendar-alt {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #A0B1C5;
            cursor: pointer;
        }
        .rating-wrapper {
            position: relative;
            width: 100%;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .form-range {
            position: absolute;
            width: 100%;
            height: 10px;
            z-index: 2;
            cursor: pointer;
            -webkit-appearance: none;
            background: transparent;
        }
        .form-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #00F7FF;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 247, 255, 0.5);
            transition: transform 0.3s ease;
        }
        .form-range::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #00F7FF;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 247, 255, 0.5);
            transition: transform 0.3s ease;
        }
        .form-range::-webkit-slider-runnable-track {
            height: 10px;
            background: transparent;
        }
        .form-range::-moz-range-track {
            height: 10px;
            background: transparent;
        }
        .rating-track {
            position: absolute;
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1;
        }
        .rating-fill {
            height: 100%;
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            border-radius: 5px;
            position: absolute;
            left: 0;
            top: 0;
            z-index: 0;
            width: 0;
        }
        .rating-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            z-index: 1;
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="fade-in"><i class="fas fa-chart-line"></i> Дневник трейдера</h1>

        <div id="main" class="card fade-in">
            <form id="tradeForm" onsubmit="saveTrade(event)">
                <div class="row mb-2">
                    <div class="col-6">
                        <label for="coin" class="form-label" data-tooltip="Выберите или добавьте монету">Монета</label>
                        <div class="d-flex">
                            <select class="form-select" id="coin" required>
                                <option value="BTCUSD">BTCUSD</option>
                                <option value="ETHUSD">ETHUSD</option>
                                <option value="XRPUSD">XRPUSD</option>
                            </select>
                            <button type="button" class="btn-add-coin" onclick="promptAddCoin()" data-tooltip="Добавить новую монету"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <div class="col-6">
                        <label for="position" class="form-label" data-tooltip="Выберите тип позиции">Позиция</label>
                        <select class="form-select" id="position" required>
                            <option value="Short">Short</option>
                            <option value="Long">Long</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-6">
                        <label for="open_date" class="form-label" data-tooltip="Выберите дату открытия сделки">Дата открытия</label>
                        <div class="input-with-button">
                            <input type="date" class="form-control" id="open_date" required max="${new Date().toISOString().split('T')[0]}">
                            <i class="fas fa-calendar-alt" onclick="document.getElementById('open_date').showPicker();" data-tooltip="Выбрать дату"></i>
                        </div>
                    </div>
                    <div class="col-6">
                        <label for="risk" class="form-label" data-tooltip="Введите риск в долларах">Риск на сделку ($)</label>
                        <input type="number" step="0.01" class="form-control" id="risk" required min="0">
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-6">
                        <label for="profit" class="form-label" data-tooltip="Введите прибыль в долларах">Прибыль ($)</label>
                        <input type="number" step="0.01" class="form-control" id="profit" min="0">
                    </div>
                    <div class="col-6">
                        <label for="loss" class="form-label" data-tooltip="Введите убыток в долларах">Убыток ($)</label>
                        <input type="number" step="0.01" class="form-control" id="loss" min="0">
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-6">
                        <label for="result" class="form-label" data-tooltip="Введите итог сделки в процентах">Итог сделки (%)</label>
                        <input type="number" step="0.01" class="form-control" id="result" required>
                    </div>
                    <div class="col-6">
                        <label for="notes" class="form-label" data-tooltip="Добавьте заметки к сделке">Заметки</label>
                        <div class="input-with-button">
                            <input type="text" class="form-control" id="notes">
                            <button type="button" class="btn-add-image" onclick="document.getElementById('notesImage').click()" data-tooltip="Добавить изображение"><i class="fas fa-paperclip"></i></button>
                            <input type="file" class="form-control" id="notesImage" accept="image/*" onchange="handleImageUpload('notes', event)" style="display: none;">
                        </div>
                        <div id="notesImageIcon" class="image-icon-container" style="display: none;">
                            <img id="notesImagePreview" class="image-icon" onclick="showImageModal('notes')" alt="Иконка заметок">
                        </div>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-12">
                        <label for="setup" class="form-label" data-tooltip="Опишите сетап сделки">Сетап</label>
                        <div class="input-with-button">
                            <textarea class="form-control" id="setup" required style="height: 80px; resize: vertical;"></textarea>
                            <button type="button" class="btn-add-image" onclick="document.getElementById('setupImage').click()" data-tooltip="Добавить изображение"><i class="fas fa-paperclip"></i></button>
                            <input type="file" class="form-control" id="setupImage" accept="image/*" onchange="handleImageUpload('setup', event)" style="display: none;">
                        </div>
                        <div id="setupImageIcon" class="image-icon-container" style="display: none;">
                            <img id="setupImagePreview" class="image-icon" onclick="showImageModal('setup')" alt="Иконка сетапа">
                        </div>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-12">
                        <label for="rating" class="form-label" data-tooltip="Оцените сделку от 1 до 5">Оценка (1-5)</label>
                        <div class="rating-wrapper">
                            <input type="range" class="form-range" id="rating" min="1" max="5" value="1">
                            <div class="rating-track">
                                <div class="rating-fill" id="ratingFill"></div>
                            </div>
                            <div class="rating-value" id="ratingValue">1</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <button type="submit" class="btn w-100" id="submitBtn" data-tooltip="Сохранить или добавить сделку"><i class="fas fa-plus"></i> Добавить сделку</button>
                        <button type="button" class="btn w-100 mt-2" id="cancelBtn" style="display: none;" onclick="cancelEdit()" data-tooltip="Отменить редактирование">Отмена</button>
                    </div>
                </div>
            </form>
        </div>

        <div id="view" class="card fade-in" style="display: none;">
            <h3 class="text-center mb-2" style="font-size: 1.8rem; background: linear-gradient(90deg, #00F7FF, #FF00E6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Мои сделки</h3>
            <div class="progress-bar" id="successProgress"><span>0.00%</span></div>
            <div class="row mb-3">
                <div class="col-6">
                    <label for="filterCoin" class="form-label">Фильтр по монете</label>
                    <select class="form-select" id="filterCoin" onchange="applyFilters()">
                        <option value="">Все</option>
                    </select>
                </div>
                <div class="col-6">
                    <label for="filterDate" class="form-label">Фильтр по дате</label>
                    <div class="input-with-button">
                        <input type="date" class="form-control" id="filterDate" onchange="applyFilters()">
                        <i class="fas fa-calendar-alt" onclick="document.getElementById('filterDate').showPicker();"></i>
                    </div>
                </div>
                <div class="col-6">
                    <label for="filterPosition" class="form-label">Фильтр по позиции</label>
                    <select class="form-select" id="filterPosition" onchange="applyFilters()">
                        <option value="">Все</option>
                        <option value="Short">Short</option>
                        <option value="Long">Long</option>
                    </select>
                </div>
                <div class="col-6">
                    <label for="filterRating" class="form-label">Фильтр по оценке</label>
                    <select class="form-select" id="filterRating" onchange="applyFilters()">
                        <option value="">Все</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
            </div>
            <table class="table table-striped" id="tradesTable">
                <thead>
                    <tr>
                        <th data-sort="id">ID</th>
                        <th data-sort="coin">Монета</th>
                        <th data-sort="position">Позиция</th>
                        <th data-sort="open_date">Дата</th>
                        <th data-sort="risk">Риск ($)</th>
                        <th data-sort="profit">Прибыль ($)</th>
                        <th data-sort="loss">Убыток ($)</th>
                        <th data-sort="result">Итог (%)</th>
                        <th>Сетап</th>
                        <th>Заметки</th>
                        <th data-sort="rating">Оценка</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="tradesBody"></tbody>
            </table>
            <div class="row mt-2">
                <div class="col-6">
                    <button class="btn w-100" onclick="exportToCSV()">Экспорт в CSV</button>
                </div>
                <div class="col-6">
                    <button class="btn w-100" onclick="exportToPDF()">Экспорт в PDF</button>
                </div>
            </div>
        </div>

        <div id="stats" class="stats-container fade-in" style="display: none;">
            <h3 class="text-center mb-4">Статистика</h3>
            <div class="stats-grid">
                <div class="stat-card" data-tooltip="Максимальная прибыль за одну сделку">
                    <i class="fas fa-arrow-up stat-icon profit"></i>
                    <h4>Макс. прибыль</h4>
                    <p><span id="maxProfit">0.00</span>$</p>
                </div>
                <div class="stat-card" data-tooltip="Максимальный убыток за одну сделку">
                    <i class="fas fa-arrow-down stat-icon loss"></i>
                    <h4>Макс. убыток</h4>
                    <p><span id="maxLoss">0.00</span>$</p>
                </div>
                <div class="stat-card" data-tooltip="Соотношение лонгов к шортам">
                    <i class="fas fa-balance-scale stat-icon"></i>
                    <h4>Лонги/Шорты</h4>
                    <p><span id="longShortRatio">0/0</span></p>
                </div>
                <div class="stat-card" data-tooltip="Количество прибыльных сделок">
                    <i class="fas fa-check-circle stat-icon profit"></i>
                    <h4>Прибыльных</h4>
                    <p><span id="profitableTrades">0</span></p>
                </div>
                <div class="stat-card" data-tooltip="Количество убыточных сделок">
                    <i class="fas fa-times-circle stat-icon loss"></i>
                    <h4>Убыточных</h4>
                    <p><span id="lossTrades">0</span></p>
                </div>
                <div class="stat-card" data-tooltip="Общая прибыль по всем сделкам">
                    <i class="fas fa-money-bill-wave stat-icon profit"></i>
                    <h4>Общая прибыль</h4>
                    <p><span id="totalProfit">0.00</span>$</p>
                </div>
                <div class="stat-card" data-tooltip="Общий убыток по всем сделкам">
                    <i class="fas fa-money-bill-wave stat-icon loss"></i>
                    <h4>Общий убыток</h4>
                    <p><span id="totalLoss">0.00</span>$</p>
                </div>
                <div class="stat-card" data-tooltip="Сумма итогов сделок в процентах">
                    <i class="fas fa-percent stat-icon"></i>
                    <h4>Общий % к депозиту</h4>
                    <p><span id="totalDepositPercent">0.00</span>%</p>
                </div>
            </div>
            <div class="mt-4">
                <h3 class="text-center mb-4" style="font-size: 1.5rem;">Достижения</h3>
                <div class="stats-grid" id="achievementsGrid">
                    <div class="stat-card" data-tooltip="За первую записанную сделку">
                        <i class="fas fa-trophy stat-icon profit"></i>
                        <h4>Новичок</h4>
                        <p id="newbieAchievement">Не получено</p>
                    </div>
                    <div class="stat-card" data-tooltip="За 10 сделок подряд без убытков">
                        <i class="fas fa-star stat-icon profit"></i>
                        <h4>Стабильный трейдер</h4>
                        <p id="stableTraderAchievement">Не получено</p>
                    </div>
                    <div class="stat-card" data-tooltip="За заполнение сетапов и заметок в 20 сделках">
                        <i class="fas fa-book stat-icon profit"></i>
                        <h4>Мастер анализа</h4>
                        <p id="analysisMasterAchievement">Не получено</p>
                    </div>
                    <div class="stat-card" data-tooltip="За сделки с риском не более 2% от общего риска">
                        <i class="fas fa-shield-alt stat-icon profit"></i>
                        <h4>Мастер риска</h4>
                        <p id="riskMasterAchievement">Не получено</p>
                    </div>
                    <div class="stat-card" data-tooltip="За общую прибыль более $10,000">
                        <i class="fas fa-crown stat-icon profit"></i>
                        <h4>Король прибыли</h4>
                        <p id="profitKingAchievement">Не получено</p>
                    </div>
                    <div class="stat-card" data-tooltip="За 100+ сделок">
                        <i class="fas fa-running stat-icon profit"></i>
                        <h4>Марафонский трейдер</h4>
                        <p id="marathonTraderAchievement">Не получено</p>
                    </div>
                </div>
            </div>
            <div class="mt-4">
                <h3 class="text-center mb-4" style="font-size: 1.5rem;">Уровень трейдера</h3>
                <div class="stat-card mx-auto" data-tooltip="Ваш текущий уровень трейдера">
                    <i class="fas fa-user-graduate stat-icon profit"></i>
                    <h4 id="traderLevelTitle">Стажер</h4>
                    <p><span id="traderLevel">Уровень 1</span></p>
                </div>
                <div class="progress-bar mt-3" id="levelProgress"><span id="levelProgressText">0%</span></div>
            </div>
        </div>

        <div id="loadingSpinner" class="spinner" style="display: none;">
            <div class="spinner-circle"></div>
        </div>

        <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="detailModalLabel">Детали</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                    </div>
                    <div class="modal-body" id="detailModalBody"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-action" data-bs-dismiss="modal">Закрыть</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="imageModalLabel">Просмотр изображения</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                    </div>
                    <div class="modal-body">
                        <img id="modalImage" class="modal-image" alt="Полное изображение">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-action" data-bs-dismiss="modal">Закрыть</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" onclick="showSection('main')"><i class="fas fa-home"></i> Главная</a>
            <a class="navbar-brand active" href="#" onclick="showSection('view')"><i class="fas fa-table"></i> Мои сделки</a>
            <a class="navbar-brand" href="#" onclick="showSection('stats')"><i class="fas fa-chart-bar"></i> Статистика</a>
            <div class="lang-toggle" onclick="toggleLanguageDropdown()">
                <span class="lang-icon">RU</span>
                <i class="fas fa-globe" style="margin-left: 5px;"></i>
                <div class="lang-dropdown">
                    <div class="lang-option" data-lang="ru">RU</div>
                    <div class="lang-option" data-lang="en">EN</div>
                </div>
            </div>
        </div>
    </nav>

    <style>
        @media (max-width: 968px) {
            h1 { font-size: 1.5rem; }
            .card { padding: 10px; }
            .form-label { font-size: 0.8rem; }
            .form-control, .form-select { font-size: 0.9rem; height: 35px; }
            .btn { padding: 6px 12px; font-size: 0.8rem; }
            .table { font-size: 0.8rem; }
            .table th, .table td { padding: 6px; }
            .navbar-brand { 
                font-size: 0.7rem;
                padding: 6px 8px;
            }
            .lang-toggle { 
                font-size: 0.7rem;
                padding: 6px 8px;
            }
            .lang-icon { font-size: 0.6rem; }
            .lang-dropdown { min-width: 60px; }
            .lang-option { font-size: 0.6rem; padding: 3px 8px; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
            .stat-card { padding: 10px; max-width: 150px; }
            .stat-card h4 { font-size: 0.9rem; }
            .stat-card p { font-size: 1rem; }
            .stat-card span { font-size: 1.1rem; }
            .stat-icon { font-size: 1.5rem; }
            .rating-value { font-size: 1rem; top: -18px; }
            .rating-track, .form-range { height: 8px; }
            .rating-fill { height: 8px; }
            .form-range::-webkit-slider-thumb {
                width: 14px;
                height: 14px;
            }
            .form-range::-moz-range-thumb {
                width: 14px;
                height: 14px;
            }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        let trades = JSON.parse(localStorage.getItem("trades")) || [];
        let coins = JSON.parse(localStorage.getItem("coins")) || ["BTCUSD", "ETHUSD", "XRPUSD"];
        let images = JSON.parse(localStorage.getItem("images")) || {};
        let editingTradeId = null;
        let filters = JSON.parse(localStorage.getItem("filters")) || { coin: "", position: "", date: "", rating: "" };
        let sortColumn = null;
        let sortDirection = 1;
        let currentLanguage = localStorage.getItem("language") || "ru";
        let cachedStats = JSON.parse(localStorage.getItem("cachedStats")) || {};

        const translations = {
            ru: {
                title: "Дневник трейдера",
                mainSection: "Главная",
                viewSection: "Мои сделки",
                statsSection: "Статистика",
                coinLabel: "Монета",
                positionLabel: "Позиция",
                openDateLabel: "Дата",
                riskLabel: "Риск ($)",
                profitLabel: "Прибыль ($)",
                lossLabel: "Убыток ($)",
                resultLabel: "Итог (%)",
                notesLabel: "Заметки",
                setupLabel: "Сетап",
                ratingLabel: "Оценка",
                addTradeButton: "Добавить сделку",
                cancelButton: "Отмена",
                filterCoinLabel: "Фильтр по монете",
                filterDateLabel: "Фильтр по дате",
                filterPositionLabel: "Фильтр по позиции",
                filterRatingLabel: "Фильтр по оценке",
                allOption: "Все",
                shortOption: "Short",
                longOption: "Long",
                exportCSVButton: "Экспорт в CSV",
                exportPDFButton: "Экспорт в PDF",
                detailsLabel: "Детали",
                setupDetails: "Сетап",
                notesDetails: "Заметки",
                closeButton: "Закрыть",
                errorTitle: "Ошибка",
                deleteConfirm: "Удалить сделку с ID",
                addCoinPrompt: "Введите название новой монеты:",
                coinExistsAlert: "Монета уже существует!",
                emptyCoinAlert: "Название монеты не может быть пустым!",
                tradeAddedAlert: "Сделка добавлена!",
                tradeUpdatedAlert: "Сделка обновлена!",
                tradeDeletedAlert: "Сделка удалена!",
                noTradesAlert: "Нет сделок для экспорта!",
                requiredFieldAlert: "Поле",
                requiredFieldMessage: "обязательно для заполнения!",
                negativeValueAlert: "не может быть отрицательным!",
                maxProfitLabel: "Макс. прибыль",
                maxLossLabel: "Макс. убыток",
                longShortRatioLabel: "Лонги/Шорты",
                profitableTradesLabel: "Прибыльных",
                lossTradesLabel: "Убыточных",
                totalProfitLabel: "Общая прибыль",
                totalLossLabel: "Общий убыток",
                totalDepositPercentLabel: "Общий % к депозиту",
                editButton: "Ред.",
                deleteButton: "Удал.",
                actionLabel: "Действия",
                tooltipSelectCoin: "Выберите или добавьте монету",
                tooltipSelectPosition: "Выберите тип позиции",
                tooltipSelectDate: "Выберите дату открытия сделки",
                tooltipEnterRisk: "Введите риск в долларах",
                tooltipEnterProfit: "Введите прибыль в долларах",
                tooltipEnterLoss: "Введите убыток в долларах",
                tooltipEnterResult: "Введите итог сделки в процентах",
                tooltipAddNotes: "Добавьте заметки к сделке",
                tooltipDescribeSetup: "Опишите сетап сделки",
                tooltipRateTrade: "Оцените сделку от 1 до 5",
                tooltipAddTrade: "Сохранить или добавить сделку",
                tooltipCancelEdit: "Отменить редактирование",
                tooltipAddNewCoin: "Добавить новую монету",
                tooltipAddImage: "Добавить изображение",
                tooltipMaxProfit: "Максимальная прибыль за одну сделку",
                tooltipMaxLoss: "Максимальный убыток за одну сделку",
                tooltipLongShortRatio: "Соотношение лонгов к шортам",
                tooltipProfitableTrades: "Количество прибыльных сделок",
                tooltipLossTrades: "Количество убыточных сделок",
                tooltipTotalProfit: "Общая прибыль по всем сделкам",
                tooltipTotalLoss: "Общий убыток по всем сделкам",
                tooltipTotalDepositPercent: "Сумма итогов сделок в процентах",
                newbieAchievement: "Новичок",
                stableTraderAchievement: "Стабильный трейдер",
                analysisMasterAchievement: "Мастер анализа",
                riskMasterAchievement: "Мастер риска",
                profitKingAchievement: "Король прибыли",
                marathonTraderAchievement: "Марафонский трейдер",
                achieved: "Получено",
                notAchieved: "Не получено",
                levelUpMessage: "Поздравляем! Вы достигли уровня: ",
                tipMessage: "Совет: ",
                "Стажер": "Стажер",
                "Новобранец": "Новобранец",
                "Ученик": "Ученик",
                "Трейдер": "Трейдер",
                "Опытный": "Опытный",
                "Мастер": "Мастер",
                "Эксперт": "Эксперт",
                "Профессионал": "Профессионал",
                "Легенда": "Легенда",
                "Титан рынка": "Титан рынка"
            },
            en: {
                title: "Trader's Journal",
                mainSection: "Main",
                viewSection: "My Trades",
                statsSection: "Statistics",
                coinLabel: "Coin",
                positionLabel: "Position",
                openDateLabel: "Open Date",
                riskLabel: "Risk ($)",
                profitLabel: "Profit ($)",
                lossLabel: "Loss ($)",
                resultLabel: "Result (%)",
                notesLabel: "Notes",
                setupLabel: "Setup",
                ratingLabel: "Rating",
                addTradeButton: "Add Trade",
                cancelButton: "Cancel",
                filterCoinLabel: "Filter by Coin",
                filterDateLabel: "Filter by Date",
                filterPositionLabel: "Filter by Position",
                filterRatingLabel: "Filter by Rating",
                allOption: "All",
                shortOption: "Short",
                longOption: "Long",
                exportCSVButton: "Export to CSV",
                exportPDFButton: "Export to PDF",
                detailsLabel: "Details",
                setupDetails: "Setup",
                notesDetails: "Notes",
                closeButton: "Close",
                errorTitle: "Error",
                deleteConfirm: "Delete trade with ID",
                addCoinPrompt: "Enter the name of a new coin:",
                coinExistsAlert: "Coin already exists!",
                emptyCoinAlert: "Coin name cannot be empty!",
                tradeAddedAlert: "Trade added!",
                tradeUpdatedAlert: "Trade updated!",
                tradeDeletedAlert: "Trade deleted!",
                noTradesAlert: "No trades to export!",
                requiredFieldAlert: "Field",
                requiredFieldMessage: "is required!",
                negativeValueAlert: "cannot be negative!",
                maxProfitLabel: "Max Profit",
                maxLossLabel: "Max Loss",
                longShortRatioLabel: "Longs/Shorts",
                profitableTradesLabel: "Profitable",
                lossTradesLabel: "Loss-making",
                totalProfitLabel: "Total Profit",
                totalLossLabel: "Total Loss",
                totalDepositPercentLabel: "Total % to Deposit",
                editButton: "Edit",
                deleteButton: "Delete",
                actionLabel: "Actions",
                tooltipSelectCoin: "Select or add a coin",
                tooltipSelectPosition: "Select position type",
                tooltipSelectDate: "Select trade opening date",
                tooltipEnterRisk: "Enter risk in dollars",
                tooltipEnterProfit: "Enter profit in dollars",
                tooltipEnterLoss: "Enter loss in dollars",
                tooltipEnterResult: "Enter trade result in percentage",
                tooltipAddNotes: "Add notes to the trade",
                tooltipDescribeSetup: "Describe the trade setup",
                tooltipRateTrade: "Rate the trade from 1 to 5",
                tooltipAddTrade: "Save or add trade",
                tooltipCancelEdit: "Cancel editing",
                tooltipAddNewCoin: "Add a new coin",
                tooltipAddImage: "Add an image",
                tooltipMaxProfit: "Maximum profit per trade",
                tooltipMaxLoss: "Maximum loss per trade",
                tooltipLongShortRatio: "Long/Short ratio",
                tooltipProfitableTrades: "Number of profitable trades",
                tooltipLossTrades: "Number of loss-making trades",
                tooltipTotalProfit: "Total profit across all trades",
                tooltipTotalLoss: "Total loss across all trades",
                tooltipTotalDepositPercent: "Sum of trade results in percentage",
                newbieAchievement: "Newbie",
                stableTraderAchievement: "Stable Trader",
                analysisMasterAchievement: "Analysis Master",
                riskMasterAchievement: "Risk Master",
                profitKingAchievement: "Profit King",
                marathonTraderAchievement: "Marathon Trader",
                achieved: "Achieved",
                notAchieved: "Not Achieved",
                levelUpMessage: "Congratulations! You reached level: ",
                tipMessage: "Tip: ",
                "Trainee": "Trainee",
                "Rookie": "Rookie",
                "Apprentice": "Apprentice",
                "Trader": "Trader",
                "Experienced": "Experienced",
                "Master": "Master",
                "Expert": "Expert",
                "Professional": "Professional",
                "Legend": "Legend",
                "Market Titan": "Market Titan"
            }
        };

        const tips = {
            ru: [
                "Анализируйте свои ошибки для роста.",
                "Следите за управлением рисками.",
                "Доверяйте своему торговому плану.",
                "Не гонитесь за рынком, ждите сетап.",
                "Ведите дневник регулярно."
            ],
            en: [
                "Analyze your mistakes to grow.",
                "Keep an eye on risk management.",
                "Trust your trading plan.",
                "Don’t chase the market, wait for setups.",
                "Keep your journal consistently."
            ]
        };

        function handleImageUpload(type, event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    images[type] = imageData;
                    localStorage.setItem("images", JSON.stringify(images));
                    const preview = document.getElementById(`${type}ImagePreview`);
                    preview.src = imageData;
                    document.getElementById(`${type}ImageIcon`).style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function showImageModal(type) {
            const imageSrc = images[type];
            if (imageSrc) {
                const modalImage = document.getElementById('modalImage');
                modalImage.src = imageSrc;
                document.getElementById('imageModalLabel').textContent = type === 'setup' ? translations[currentLanguage].setupDetails : translations[currentLanguage].notesDetails;
                new bootstrap.Modal(document.getElementById('imageModal')).show();
            }
        }

        function promptAddCoin() {
            const newCoin = prompt(translations[currentLanguage].addCoinPrompt);
            if (newCoin && newCoin.trim() && !coins.includes(newCoin.trim())) {
                coins.push(newCoin.trim());
                localStorage.setItem("coins", JSON.stringify(coins));
                updateCoinSelect();
                updateFilterCoinOptions();
                showNotification(translations[currentLanguage].tradeAddedAlert);
            } else if (newCoin && coins.includes(newCoin.trim())) {
                showNotification(translations[currentLanguage].coinExistsAlert, 'error');
            } else {
                showNotification(translations[currentLanguage].emptyCoinAlert, 'error');
            }
        }

        function updateCoinSelect() {
            const select = document.getElementById("coin");
            select.innerHTML = "";
            coins.forEach(coin => {
                const option = document.createElement("option");
                option.value = coin;
                option.textContent = coin;
                select.appendChild(option);
            });
        }

        function updateFilterCoinOptions() {
            const filterCoin = document.getElementById("filterCoin");
            filterCoin.innerHTML = `<option value="">${translations[currentLanguage].allOption}</option>`;
            coins.forEach(coin => {
                const option = document.createElement("option");
                option.value = coin;
                option.textContent = coin;
                filterCoin.appendChild(option);
            });
            filterCoin.value = filters.coin;
        }

        function applyFilters() {
            filters.coin = document.getElementById("filterCoin").value;
            filters.position = document.getElementById("filterPosition").value;
            filters.date = document.getElementById("filterDate").value;
            filters.rating = document.getElementById("filterRating").value;
            localStorage.setItem("filters", JSON.stringify(filters));
            updateTable();
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${year}-${month}-${day}`;
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection *= -1;
            } else {
                sortColumn = column;
                sortDirection = 1;
            }
            trades.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];
                if (column === "open_date") {
                    valA = new Date(a[column]);
                    valB = new Date(b[column]);
                } else if (["risk", "profit", "loss", "result", "rating"].includes(column)) {
                    valA = parseFloat(a[column]);
                    valB = parseFloat(b[column]);
                }
                return valA > valB ? sortDirection : valA < valB ? -sortDirection : 0;
            });
            localStorage.setItem("trades", JSON.stringify(trades));
            updateTable();
        }

        function showErrorModal(message) {
            const modalBody = document.getElementById("detailModalBody");
            modalBody.textContent = message;
            document.getElementById("detailModalLabel").textContent = translations[currentLanguage].errorTitle;
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }

        function validateForm() {
            const requiredFields = [
                { id: "coin", type: "select" },
                { id: "position", type: "select" },
                { id: "open_date", type: "date" },
                { id: "risk", type: "number", min: 0 },
                { id: "result", type: "number" },
                { id: "setup", type: "textarea" }
            ];

            for (let field of requiredFields) {
                const value = document.getElementById(field.id).value.trim();
                if (!value) {
                    showNotification(`${translations[currentLanguage].requiredFieldAlert} "${document.querySelector(`label[for="${field.id}"]`).textContent}" ${translations[currentLanguage].requiredFieldMessage}`, 'error');
                    return false;
                }
                if (field.type === "number" && parseFloat(value) < (field.min || 0)) {
                    showNotification(`${document.querySelector(`label[for="${field.id}"]`).textContent} ${translations[currentLanguage].negativeValueAlert}`, 'error');
                    return false;
                }
            }
            return true;
        }

        function showNotification(message, type = 'success') {
            Toastify({
                text: message,
                duration: 3000,
                gravity: 'top',
                position: 'right',
                backgroundColor: type === 'success' ? '#00F7FF' : type === 'error' ? '#FF00E6' : '#1E2A44',
                stopOnFocus: true
            }).showToast();
        }

        function saveTrade(event) {
            event.preventDefault();
            if (!validateForm()) return;

            showSpinner();

            setTimeout(() => {
                const tradeData = {
                    id: editingTradeId || trades.length + 1,
                    coin: document.getElementById("coin").value,
                    position: document.getElementById("position").value,
                    open_date: document.getElementById("open_date").value,
                    risk: parseFloat(document.getElementById("risk").value) || 0,
                    profit: parseFloat(document.getElementById("profit").value) || 0,
                    loss: parseFloat(document.getElementById("loss").value) || 0,
                    result: parseFloat(document.getElementById("result").value) || 0,
                    setup: document.getElementById("setup").value,
                    notes: document.getElementById("notes").value || "",
                    rating: parseInt(document.getElementById("rating").value) || 1,
                    setupImage: images['setup'] || "",
                    notesImage: images['notes'] || ""
                };

                if (editingTradeId) {
                    const tradeIndex = trades.findIndex(t => t.id === editingTradeId);
                    if (tradeIndex !== -1) {
                        trades[tradeIndex] = tradeData;
                        showNotification(translations[currentLanguage].tradeUpdatedAlert);
                    }
                    editingTradeId = null;
                    document.getElementById("submitBtn").textContent = translations[currentLanguage].addTradeButton;
                    document.getElementById("cancelBtn").style.display = "none";
                } else {
                    trades.push(tradeData);
                    showNotification(translations[currentLanguage].tradeAddedAlert);
                }

                localStorage.setItem("trades", JSON.stringify(trades));
                clearForm();
                updateTable();
                updateStats();
                autoSave();
                hideSpinner();
            }, 1000);
        }

        function cancelEdit() {
            editingTradeId = null;
            clearForm();
            document.getElementById("submitBtn").textContent = translations[currentLanguage].addTradeButton;
            document.getElementById("cancelBtn").style.display = "none";
            showSection('main');
        }

        function clearForm() {
            document.getElementById("tradeForm").reset();
            document.getElementById("coin").value = "BTCUSD";
            document.getElementById("position").value = "Short";
            document.getElementById("open_date").value = new Date().toISOString().split('T')[0];
            document.getElementById("rating").value = "1";
            document.getElementById("ratingValue").textContent = "1";
            document.getElementById("setupImageIcon").style.display = "none";
            document.getElementById("notesImageIcon").style.display = "none";
            images = {};
            localStorage.setItem("images", JSON.stringify(images));
            updateRatingDisplay();
        }

        function editTrade(id) {
            const trade = trades.find(t => t.id === id);
            if (trade) {
                editingTradeId = id;
                document.getElementById("coin").value = trade.coin;
                document.getElementById("position").value = trade.position;
                document.getElementById("open_date").value = trade.open_date;
                document.getElementById("risk").value = trade.risk;
                document.getElementById("profit").value = trade.profit;
                document.getElementById("loss").value = trade.loss;
                document.getElementById("result").value = trade.result;
                document.getElementById("setup").value = trade.setup;
                document.getElementById("notes").value = trade.notes || "";
                document.getElementById("rating").value = trade.rating;
                document.getElementById("ratingValue").textContent = trade.rating;
                document.getElementById("setupImage").value = "";
                document.getElementById("notesImage").value = "";
                images = {
                    "setup": trade.setupImage || "",
                    "notes": trade.notesImage || ""
                };
                localStorage.setItem("images", JSON.stringify(images));
                if (trade.setupImage) {
                    document.getElementById("setupImagePreview").src = trade.setupImage;
                    document.getElementById("setupImageIcon").style.display = "block";
                } else {
                    document.getElementById("setupImageIcon").style.display = "none";
                }
                if (trade.notesImage) {
                    document.getElementById("notesImagePreview").src = trade.notesImage;
                    document.getElementById("notesImageIcon").style.display = "block";
                } else {
                    document.getElementById("notesImageIcon").style.display = "none";
                }
                document.getElementById("submitBtn").textContent = translations[currentLanguage].addTradeButton;
                document.getElementById("cancelBtn").style.display = "block";
                updateRatingDisplay();
                showSection('main');
            }
        }

        function showSpinner() {
            document.getElementById('loadingSpinner').style.display = 'flex';
        }

        function hideSpinner() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }

        function updateTable() {
            const tbody = document.getElementById("tradesBody");
            tbody.innerHTML = "";
            const filteredTrades = trades.filter(trade => {
                const matchesCoin = !filters.coin || trade.coin === filters.coin;
                const matchesPosition = !filters.position || trade.position === filters.position;
                const matchesDate = !filters.date || trade.open_date === filters.date;
                const matchesRating = !filters.rating || Math.floor(trade.rating) === parseInt(filters.rating);
                return matchesCoin && matchesPosition && matchesDate && matchesRating;
            });
            filteredTrades.forEach(trade => {
                const row = document.createElement("tr");
                row.classList.add("fade-in");
                row.innerHTML = `
                    <td>${trade.id}</td>
                    <td>${trade.coin}</td>
                    <td>${trade.position}</td>
                    <td>${formatDate(trade.open_date)}</td>
                    <td>${trade.risk.toFixed(2)}</td>
                    <td>${trade.profit.toFixed(2)}</td>
                    <td>${trade.loss.toFixed(2)}</td>
                    <td>${trade.result.toFixed(2)}</td>
                    <td><button class="btn-action btn-sm" onclick="showDetailModal(${trade.id}, 'setup')">${translations[currentLanguage].detailsLabel}</button></td>
                    <td><button class="btn-action btn-sm" onclick="showDetailModal(${trade.id}, 'notes')">${translations[currentLanguage].detailsLabel}</button></td>
                    <td>${trade.rating}</td>
                    <td>
                        <button class="btn-action btn-sm" onclick="editTrade(${trade.id})">${translations[currentLanguage].editButton}</button>
                        <button class="btn-action btn-sm" onclick="deleteTrade(${trade.id})">${translations[currentLanguage].deleteButton}</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            updateProgressBar();
        }

        function updateProgressBar() {
            const successRate = trades.length > 0 ? (trades.filter(t => t.result > 0).length / trades.length * 100).toFixed(2) : 0;
            const progressBar = document.getElementById("successProgress");
            progressBar.style.width = `${successRate}%`;
            progressBar.firstChild.textContent = `${successRate}%`;
        }

        function showDetailModal(id, type) {
            const trade = trades.find(t => t.id === id);
            if (trade) {
                const modalBody = document.getElementById("detailModalBody");
                let content = "";
                if (type === 'setup') {
                    content = trade.setup || "Информация о сетапе отсутствует.";
                    if (trade.setupImage) {
                        content += `<img src="${trade.setupImage}" alt="Setup Image" style="max-width: 100%; margin-top: 10px;">`;
                    }
                } else if (type === 'notes') {
                    content = trade.notes || "Заметки отсутствуют.";
                    if (trade.notesImage) {
                        content += `<img src="${trade.notesImage}" alt="Notes Image" style="max-width: 100%; margin-top: 10px;">`;
                    }
                }
                modalBody.innerHTML = `<p>${content}</p>`;
                document.getElementById("detailModalLabel").textContent = `${translations[currentLanguage].detailsLabel} ${type === 'setup' ? translations[currentLanguage].setupDetails : translations[currentLanguage].notesDetails}`;
                new bootstrap.Modal(document.getElementById('detailModal')).show();
            }
        }

        function deleteTrade(id) {
            if (confirm(`${translations[currentLanguage].deleteConfirm} ${id}?`)) {
                trades = trades.filter(t => t.id !== id);
                trades = trades.map((trade, index) => ({ ...trade, id: index + 1 }));
                localStorage.setItem("trades", JSON.stringify(trades));
                updateTable();
                updateStats();
                showNotification(translations[currentLanguage].tradeDeletedAlert);
            }
        }

        function exportToCSV() {
            if (trades.length === 0) {
                showNotification(translations[currentLanguage].noTradesAlert, 'error');
                return;
            }
            showSpinner();
            setTimeout(() => {
                let csv = "ID,Coin,Position,Date,Risk,Profit,Loss,Result,Setup,Notes,Rating\n";
                trades.forEach(trade => {
                    csv += `${trade.id},${trade.coin},${trade.position},${trade.open_date},${trade.risk},${trade.profit},${trade.loss},${trade.result},"${trade.setup.replace(/"/g, '""')}","${(trade.notes || '').replace(/"/g, '""')}",${trade.rating}\n`;
                });
                const blob = new Blob([csv], { type: "text/csv" });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "trading_journal.csv";
                a.click();
                window.URL.revokeObjectURL(url);
                hideSpinner();
                showNotification("Экспорт в CSV успешно выполнен!", 'success');
            }, 1000);
        }

        function exportToPDF() {
            showSpinner();
            setTimeout(() => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text("Trader's Journal", 10, 10);
                let y = 20;
                doc.setFontSize(12);
                trades.forEach(trade => {
                    doc.text(`ID: ${trade.id}, Coin: ${trade.coin}, Position: ${trade.position}, Date: ${formatDate(trade.open_date)}, Risk: ${trade.risk}$, Profit: ${trade.profit}$, Loss: ${trade.loss}$, Result: ${trade.result}%, Setup: ${trade.setup}, Notes: ${trade.notes || ''}, Rating: ${trade.rating}`, 10, y);
                    y += 10;
                    if (y > 280) {
                        doc.addPage();
                        y = 10;
                    }
                });
                doc.save("trading_journal.pdf");
                hideSpinner();
                showNotification("Экспорт в PDF успешно выполнен!", 'success');
            }, 1000);
        }

        function updateStats() {
            if (trades.length === 0) {
                document.getElementById("maxProfit").textContent = "0.00";
                document.getElementById("maxLoss").textContent = "0.00";
                document.getElementById("longShortRatio").textContent = "0/0";
                document.getElementById("profitableTrades").textContent = "0";
                document.getElementById("lossTrades").textContent = "0";
                document.getElementById("totalProfit").textContent = "0.00";
                document.getElementById("totalLoss").textContent = "0.00";
                document.getElementById("totalDepositPercent").textContent = "0.00";
                document.getElementById("newbieAchievement").textContent = translations[currentLanguage].notAchieved;
                document.getElementById("stableTraderAchievement").textContent = translations[currentLanguage].notAchieved;
                document.getElementById("analysisMasterAchievement").textContent = translations[currentLanguage].notAchieved;
                document.getElementById("riskMasterAchievement").textContent = translations[currentLanguage].notAchieved;
                document.getElementById("profitKingAchievement").textContent = translations[currentLanguage].notAchieved;
                document.getElementById("marathonTraderAchievement").textContent = translations[currentLanguage].notAchieved;
                document.getElementById("traderLevelTitle").textContent = translations[currentLanguage]["Стажер"];
                document.getElementById("traderLevel").textContent = "Уровень 1";
                document.getElementById("levelProgress").style.width = "0%";
                document.getElementById("levelProgressText").textContent = "0%";
                cachedStats = {};
                localStorage.setItem("cachedStats", JSON.stringify(cachedStats));
                return;
            }

            const maxProfit = Math.max(...trades.map(t => t.profit));
            document.getElementById("maxProfit").textContent = maxProfit.toFixed(2);

            const maxLoss = Math.max(...trades.map(t => t.loss));
            document.getElementById("maxLoss").textContent = maxLoss.toFixed(2);

            const longCount = trades.filter(t => t.position === "Long").length;
            const shortCount = trades.filter(t => t.position === "Short").length;
            document.getElementById("longShortRatio").textContent = `${longCount}/${shortCount}`;

            const profitableTrades = trades.filter(t => t.result > 0).length;
            const lossTrades = trades.filter(t => t.result < 0).length;
            document.getElementById("profitableTrades").textContent = profitableTrades;
            document.getElementById("lossTrades").textContent = lossTrades;

            const totalProfit = trades.reduce((sum, t) => sum + t.profit, 0);
            const totalLoss = trades.reduce((sum, t) => sum + t.loss, 0);
            document.getElementById("totalProfit").textContent = totalProfit.toFixed(2);
            document.getElementById("totalLoss").textContent = totalLoss.toFixed(2);

            // Расчет "Общий % к депозиту" как суммы всех значений result
            const totalDepositPercent = trades.reduce((sum, t) => sum + t.result, 0);
            document.getElementById("totalDepositPercent").textContent = totalDepositPercent.toFixed(2);

            if (!cachedStats.tradeCount || cachedStats.tradeCount !== trades.length) {
                cachedStats.tradeCount = trades.length;
                cachedStats.consecutiveNoLoss = 0;
                for (let i = trades.length - 1; i >= 0; i--) {
                    if (trades[i].result >= 0) cachedStats.consecutiveNoLoss++;
                    else break;
                }
                cachedStats.detailedTrades = trades.filter(t => t.setup && t.notes).length;
                cachedStats.profitableRate = (profitableTrades / trades.length) * 100;
                cachedStats.totalProfit = totalProfit - totalLoss;
                cachedStats.avgRating = trades.reduce((sum, t) => sum + t.rating, 0) / trades.length || 0;
                cachedStats.totalRisk = trades.reduce((sum, t) => sum + t.risk, 0);
                localStorage.setItem("cachedStats", JSON.stringify(cachedStats));
            }

            // Геймификация: Достижения
            const achievements = {
                newbie: {
                    condition: trades.length >= 1,
                    label: translations[currentLanguage].newbieAchievement,
                    tooltip: "Запишите первую сделку"
                },
                stableTrader: {
                    condition: cachedStats.consecutiveNoLoss >= 10,
                    label: translations[currentLanguage].stableTraderAchievement,
                    tooltip: `Осталось ${10 - cachedStats.consecutiveNoLoss} сделок без убытков из 10`
                },
                analysisMaster: {
                    condition: cachedStats.detailedTrades >= 20,
                    label: translations[currentLanguage].analysisMasterAchievement,
                    tooltip: `Осталось ${20 - cachedStats.detailedTrades} сделок с анализом из 20`
                },
                riskMaster: {
                    condition: trades.every(t => t.risk <= (cachedStats.totalRisk / trades.length) * 0.02),
                    label: translations[currentLanguage].riskMasterAchievement,
                    tooltip: trades.length > 0 ? (trades.every(t => t.risk <= (cachedStats.totalRisk / trades.length) * 0.02) ? "Достижение получено!" : "Снизьте риск в сделках до 2% от среднего!") : "Запишите сделки с низким риском"
                },
                profitKing: {
                    condition: cachedStats.totalProfit >= 10000,
                    label: translations[currentLanguage].profitKingAchievement,
                    tooltip: `Осталось $${(10000 - cachedStats.totalProfit).toFixed(2)} до $10,000 прибыли`
                },
                marathonTrader: {
                    condition: trades.length >= 100,
                    label: translations[currentLanguage].marathonTraderAchievement,
                    tooltip: `Осталось ${100 - trades.length} сделок из 100`
                }
            };

            // Обновление текста достижений (без повтора названия)
            document.getElementById("newbieAchievement").textContent = achievements.newbie.condition ? translations[currentLanguage].achieved : translations[currentLanguage].notAchieved;
            document.getElementById("stableTraderAchievement").textContent = achievements.stableTrader.condition ? translations[currentLanguage].achieved : translations[currentLanguage].notAchieved;
            document.getElementById("analysisMasterAchievement").textContent = achievements.analysisMaster.condition ? translations[currentLanguage].achieved : translations[currentLanguage].notAchieved;
            document.getElementById("riskMasterAchievement").textContent = achievements.riskMaster.condition ? translations[currentLanguage].achieved : translations[currentLanguage].notAchieved;
            document.getElementById("profitKingAchievement").textContent = achievements.profitKing.condition ? translations[currentLanguage].achieved : translations[currentLanguage].notAchieved;
            document.getElementById("marathonTraderAchievement").textContent = achievements.marathonTrader.condition ? translations[currentLanguage].achieved : translations[currentLanguage].notAchieved;

            // Уровни трейдера
            const levels = [
                { name: translations[currentLanguage]["Стажер"], trades: 0, profit: 0, rating: 0 },
                { name: translations[currentLanguage]["Новобранец"], trades: 10, profit: 100, rating: 2 },
                { name: translations[currentLanguage]["Ученик"], trades: 20, profit: 500, rating: 2.5 },
                { name: translations[currentLanguage]["Трейдер"], trades: 30, profit: 1000, rating: 3 },
                { name: translations[currentLanguage]["Опытный"], trades: 50, profit: 2000, rating: 3.5 },
                { name: translations[currentLanguage]["Мастер"], trades: 70, profit: 3500, rating: 4 },
                { name: translations[currentLanguage]["Эксперт"], trades: 90, profit: 5000, rating: 4.2 },
                { name: translations[currentLanguage]["Профессионал"], trades: 120, profit: 7000, rating: 4.5 },
                { name: translations[currentLanguage]["Легенда"], trades: 150, profit: 10000, rating: 4.7 },
                { name: translations[currentLanguage]["Титан рынка"], trades: 200, profit: 15000, rating: 4.9 }
            ];

            let currentLevel = 1;
            for (let i = 0; i < levels.length; i++) {
                if (trades.length >= levels[i].trades && (cachedStats.totalProfit || 0) >= levels[i].profit && (cachedStats.avgRating || 0) >= levels[i].rating) {
                    currentLevel = i + 1;
                } else {
                    break;
                }
            }

            const nextLevel = currentLevel < levels.length ? levels[currentLevel] : null;
            let progress = 0;
            if (nextLevel) {
                const tradeProgress = Math.min((trades.length / nextLevel.trades) * 100, 100);
                const profitProgress = Math.min(((cachedStats.totalProfit || 0) / nextLevel.profit) * 100, 100);
                const ratingProgress = Math.min(((cachedStats.avgRating || 0) / nextLevel.rating) * 100, 100);
                progress = Math.round((tradeProgress + profitProgress + ratingProgress) / 3);
            }

            document.getElementById("traderLevelTitle").textContent = levels[currentLevel - 1].name;
            document.getElementById("traderLevel").textContent = `Уровень ${currentLevel}`;
            document.getElementById("levelProgress").style.width = `${progress}%`;
            document.getElementById("levelProgressText").textContent = `${progress}%`;

            // Уведомление о повышении уровня
            const previousLevel = parseInt(localStorage.getItem("traderLevel") || "1");
            if (currentLevel > previousLevel) {
                showNotification(`${translations[currentLanguage].levelUpMessage} ${levels[currentLevel - 1].name}!`);
                const randomTip = tips[currentLanguage][Math.floor(Math.random() * tips[currentLanguage].length)];
                showNotification(`${translations[currentLanguage].tipMessage}${randomTip}`);
            }
            localStorage.setItem("traderLevel", currentLevel);
        }

        function autoSave() {
            localStorage.setItem("trades", JSON.stringify(trades));
            localStorage.setItem("coins", JSON.stringify(coins));
            localStorage.setItem("images", JSON.stringify(images));
            localStorage.setItem("filters", JSON.stringify(filters));
        }

        function showSection(section) {
            document.getElementById("main").style.display = section === "main" ? "block" : "none";
            document.getElementById("view").style.display = section === "view" ? "block" : "none";
            document.getElementById("stats").style.display = section === "stats" ? "block" : "none";
            document.querySelectorAll(".navbar-brand").forEach(btn => btn.classList.remove("active"));
            document.querySelector(`.navbar-brand[onclick="showSection('${section}')"]`).classList.add("active");
            if (section === "view") updateTable();
            if (section === "stats") updateStats();
        }

        function toggleLanguageDropdown() {
            const dropdown = document.querySelector(".lang-dropdown");
            dropdown.classList.toggle("active");
        }

        function updateLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem("language", lang);
            document.querySelector(".lang-icon").textContent = lang.toUpperCase();
            document.querySelector("html").lang = lang;
            document.querySelector("h1").textContent = translations[lang].title;
            document.querySelector(".navbar-brand[onclick=\"showSection('main')\"]").innerHTML = `<i class="fas fa-home"></i> ${translations[lang].mainSection}`;
            document.querySelector(".navbar-brand[onclick=\"showSection('view')\"]").innerHTML = `<i class="fas fa-table"></i> ${translations[lang].viewSection}`;
            document.querySelector(".navbar-brand[onclick=\"showSection('stats')\"]").innerHTML = `<i class="fas fa-chart-bar"></i> ${translations[lang].statsSection}`;
            document.querySelector("label[for='coin']").textContent = translations[lang].coinLabel;
            document.querySelector("label[for='position']").textContent = translations[lang].positionLabel;
            document.querySelector("label[for='open_date']").textContent = translations[lang].openDateLabel;
            document.querySelector("label[for='risk']").textContent = translations[lang].riskLabel;
            document.querySelector("label[for='profit']").textContent = translations[lang].profitLabel;
            document.querySelector("label[for='loss']").textContent = translations[lang].lossLabel;
            document.querySelector("label[for='result']").textContent = translations[lang].resultLabel;
            document.querySelector("label[for='notes']").textContent = translations[lang].notesLabel;
            document.querySelector("label[for='setup']").textContent = translations[lang].setupLabel;
            document.querySelector("label[for='rating']").textContent = translations[lang].ratingLabel;
            document.getElementById("submitBtn").innerHTML = `<i class="fas fa-plus"></i> ${translations[lang].addTradeButton}`;
            document.getElementById("cancelBtn").textContent = translations[lang].cancelButton;
            document.querySelector("label[for='filterCoin']").textContent = translations[lang].filterCoinLabel;
            document.querySelector("label[for='filterDate']").textContent = translations[lang].filterDateLabel;
            document.querySelector("label[for='filterPosition']").textContent = translations[lang].filterPositionLabel;
            document.querySelector("label[for='filterRating']").textContent = translations[lang].filterRatingLabel;
            document.getElementById("filterPosition").innerHTML = `
                <option value="">${translations[lang].allOption}</option>
                <option value="Short">${translations[lang].shortOption}</option>
                <option value="Long">${translations[lang].longOption}</option>
            `;
            document.getElementById("filterRating").innerHTML = `
                <option value="">${translations[lang].allOption}</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
            `;
            document.querySelector("th[data-sort='id']").textContent = "ID";
            document.querySelector("th[data-sort='coin']").textContent = translations[lang].coinLabel;
            document.querySelector("th[data-sort='position']").textContent = translations[lang].positionLabel;
            document.querySelector("th[data-sort='open_date']").textContent = translations[lang].openDateLabel;
            document.querySelector("th[data-sort='risk']").textContent = translations[lang].riskLabel;
            document.querySelector("th[data-sort='profit']").textContent = translations[lang].profitLabel;
            document.querySelector("th[data-sort='loss']").textContent = translations[lang].lossLabel;
            document.querySelector("th[data-sort='result']").textContent = translations[lang].resultLabel;
            document.querySelector("th[data-sort='rating']").textContent = translations[lang].ratingLabel;
            document.querySelector("#tradesTable th:nth-child(9)").textContent = translations[lang].setupLabel;
            document.querySelector("#tradesTable th:nth-child(10)").textContent = translations[lang].notesLabel;
            document.querySelector("#tradesTable th:nth-child(12)").textContent = translations[lang].actionLabel;
            document.querySelector("button[onclick='exportToCSV()']").textContent = translations[lang].exportCSVButton;
            document.querySelector("button[onclick='exportToPDF()']").textContent = translations[lang].exportPDFButton;
            document.querySelector("#stats h3").textContent = translations[lang].statsSection;
            document.querySelector("#stats .stats-grid .stat-card:nth-child(1) h4").textContent = translations[lang].maxProfitLabel;
            document.querySelector("#stats .stats-grid .stat-card:nth-child(2) h4").textContent = translations[lang].maxLossLabel;
            document.querySelector("#stats .stats-grid .stat-card:nth-child(3) h4").textContent = translations[lang].longShortRatioLabel;
            document.querySelector("#stats .stats-grid .stat-card:nth-child(4) h4").textContent = translations[lang].profitableTradesLabel;
            document.querySelector("#stats .stats-grid .stat-card:nth-child(5) h4").textContent = translations[lang].lossTradesLabel;
            document.querySelector("#stats .stats-grid .stat-card:nth-child(6) h4").textContent = translations[lang].totalProfitLabel;
            document.querySelector("#stats .stats-grid .stat-card:nth-child(7) h4").textContent = translations[lang].totalLossLabel;
            document.querySelector("#stats .stats-grid .stat-card:nth-child(8) h4").textContent = translations[lang].totalDepositPercentLabel;
            updateFilterCoinOptions();
            updateTable();
            updateStats();
        }

        function updateRatingDisplay() {
            const rating = document.getElementById("rating").value;
            document.getElementById("ratingValue").textContent = rating;
            const ratingFill = document.getElementById("ratingFill");
            const percentage = ((rating - 1) / 4) * 100;
            ratingFill.style.width = `${percentage}%`;
        }

        document.getElementById("rating").addEventListener("input", updateRatingDisplay);

        document.querySelectorAll("th[data-sort]").forEach(th => {
            th.addEventListener("click", () => sortTable(th.dataset.sort));
        });

        document.querySelectorAll(".lang-option").forEach(option => {
            option.addEventListener("click", () => {
                const lang = option.dataset.lang;
                updateLanguage(lang);
                toggleLanguageDropdown();
            });
        });

        window.addEventListener("load", () => {
            updateCoinSelect();
            updateFilterCoinOptions();
            updateLanguage(currentLanguage);
            updateTable();
            updateStats();
            clearForm();
            document.getElementById("rating").value = "1";
            updateRatingDisplay();
        });
    </script>
</body>
</html>
