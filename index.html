<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дневник трейдера</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: #1E2A44;
            color: #ECF0F1;
            font-family: 'Segoe UI', sans-serif;
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }
        body.light {
            background: #F0F4F8;
            color: #333;
        }
        .container {
            padding: 10px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: fadeIn 1.5s ease-in-out;
        }
        h1.light {
            background: linear-gradient(90deg, #007BFF, #FF1493);
        }
        .card {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: transform 0.3s;
        }
        .card.light {
            background: rgba(240, 244, 248, 0.9);
        }
        .card:hover {
            transform: translateY(-3px);
        }
        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #FFF;
            border-radius: 4px;
            height: 35px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .form-control.light, .form-select.light {
            background: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.1);
            color: #333;
        }
        .form-control:focus, .form-select:focus {
            border-color: #00F7FF;
            box-shadow: 0 0 5px rgba(0, 247, 255, 0.5);
        }
        .form-control.light:focus, .form-select.light:focus {
            border-color: #007BFF;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }
        .form-select option {
            background: #1E2A44;
            color: #FFF;
        }
        .form-select.light option {
            background: #F0F4F8;
            color: #333;
        }
        .form-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #A0B1C5;
        }
        .form-label.light {
            color: #555;
        }
        .btn {
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .btn.light {
            background: linear-gradient(90deg, #FFF5E1, #FF9999);
        }
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0, 247, 255, 0.8);
        }
        .btn.light:hover {
            box-shadow: 0 0 10px rgba(255, 153, 153, 0.8);
        }
        .btn-action {
            background: #1E2A44;
            color: #00F7FF;
            border: 1px solid #00F7FF;
            padding: 4px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            margin: 0 2px;
            transition: all 0.3s;
        }
        .btn-action.light {
            background: #D9E2EC;
            color: #007BFF;
            border-color: #007BFF;
        }
        .btn-action:hover {
            background: #00F7FF;
            color: #1E2A44;
        }
        .btn-action.light:hover {
            background: #007BFF;
            color: #D9E2EC;
        }
        .btn-add-coin, .btn-add-image {
            background: #00F7FF;
            color: #1E2A44;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.9rem;
            margin-left: 5px;
            transition: all 0.3s;
        }
        .btn-add-coin.light, .btn-add-image.light {
            background: #007BFF;
            color: #F0F4F8;
        }
        .btn-add-coin:hover, .btn-add-image:hover {
            background: #FF00E6;
            box-shadow: 0 0 5px #FF00E6;
        }
        .btn-add-coin.light:hover, .btn-add-image.light:hover {
            background: #FF1493;
            box-shadow: 0 0 5px #FF1493;
        }
        .table {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 8px;
            width: 100%;
            font-size: 0.9rem;
        }
        .table.light {
            background: rgba(240, 244, 248, 0.9);
        }
        .table th {
            background: rgba(255, 255, 255, 0.1);
            color: #00F7FF;
            text-transform: uppercase;
            font-size: 0.8rem;
            text-align: center;
            padding: 6px;
            cursor: pointer;
        }
        .table.light th {
            background: rgba(0, 0, 0, 0.1);
            color: #007BFF;
        }
        .table th:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .table.light th:hover {
            background: rgba(0, 0, 0, 0.2);
        }
        .table td {
            background: rgba(255, 255, 255, 0.05);
            color: #FFF;
            text-align: center;
            padding: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .table td:nth-child(9), .table td:nth-child(10) {
            padding-top: 10px;
        }
        .table.light td {
            background: rgba(0, 0, 0, 0.05);
            color: #333;
        }
        .table td.setup-cell, .table td.notes-cell {
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .table td.setup-cell:hover, .table td.notes-cell:hover {
            overflow: visible;
            white-space: normal;
        }
        @media (min-width: 768px) {
            h1 { font-size: 3rem; margin-bottom: 20px; }
            .form-label { font-size: 1rem; }
            .form-control, .form-select { font-size: 1rem; height: 40px; }
            .btn { font-size: 1rem; padding: 8px 16px; }
            .btn-action { font-size: 0.9rem; padding: 5px 8px; }
            .btn-add-coin, .btn-add-image { font-size: 1rem; padding: 5px 10px; }
            .table { font-size: 1rem; }
            .table th, .table td { padding: 8px; }
            .navbar-brand { font-size: 1.1rem; padding: 10px 15px; }
            .search-input { font-size: 1rem; padding: 5px 10px; }
        }
        @media (max-width: 768px) {
            h1 { font-size: 1.2rem; margin-bottom: 10px; }
            .container { padding: 5px; }
            .card { padding: 8px; margin-bottom: 8px; }
            .form-label { font-size: 0.7rem; }
            .form-control, .form-select { height: 30px; font-size: 0.8rem; }
            .btn { padding: 5px 10px; font-size: 0.8rem; }
            .btn-action { padding: 3px 5px; font-size: 0.6rem; margin: 0 1px; }
            .btn-add-coin, .btn-add-image { padding: 3px 6px; font-size: 0.8rem; margin-left: 3px; }
            .table { font-size: 0.7rem; display: block; }
            .table th, .table td {
                padding: 4px;
                display: block;
                text-align: left;
                border-bottom: none;
            }
            .table th { display: none; }
            .table td {
                position: relative;
                padding-left: 30%;
            }
            .table td:before {
                content: attr(data-label);
                position: absolute;
                left: 5px;
                width: 25%;
                padding-right: 10px;
                font-weight: bold;
                color: #00F7FF;
            }
            .table td.actions-cell {
                padding-left: 0;
                text-align: right;
                padding-right: 5px;
            }
            .table td.actions-cell:before { content: none; }
            .table .accordion-content {
                display: none;
                padding: 10px 5px;
                background: rgba(255, 255, 255, 0.05);
                margin: 5px 0;
                border-radius: 4px;
            }
            .table .accordion-content.light {
                background: rgba(0, 0, 0, 0.05);
            }
            .table .accordion-content.active { display: block; }
            .table .accordion-content p { margin: 5px 0; font-size: 0.8rem; }
            .table .accordion-content img {
                max-width: 100%;
                max-height: 150px;
                margin-top: 5px;
                border-radius: 4px;
                border: 1px solid #00F7FF;
            }
            .table .accordion-content.light img { border-color: #007BFF; }
        }
        .navbar {
            background: rgba(15, 23, 42, 0.9);
            padding: 8px 0;
            position: fixed;
            bottom: 0;
            width: 100%;
        }
        .navbar.light { background: rgba(240, 244, 248, 0.9); }
        .navbar-brand {
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            color: #1E2A44;
            font-size: 1rem;
            padding: 8px 12px;
            border-radius: 15px;
            transition: transform 0.3s;
            text-align: center;
            margin: 0 5px;
            text-decoration: none;
        }
        .navbar-brand.light {
            background: linear-gradient(90deg, #FFF5E1, #FF9999);
            color: #333;
        }
        .navbar-brand:hover { transform: scale(1.05); }
        .navbar-brand.active { background: linear-gradient(90deg, #FF00E6, #00F7FF); }
        .navbar-brand.light.active { background: linear-gradient(90deg, #FF9999, #FFF5E1); }
        .search-input {
            width: 100%;
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: #FFF;
        }
        .search-input.light {
            border-color: rgba(0, 0, 0, 0.1);
            background: rgba(0, 0, 0, 0.05);
            color: #333;
        }
        .stats-card {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }
        .stats-card.light {
            background: rgba(240, 244, 248, 0.95);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .stats-card:hover { transform: translateY(-5px); }
        .stats-card h3 {
            color: #00F7FF;
            font-size: 1.8rem;
            margin-bottom: 15px;
            text-align: center;
        }
        .stats-card.light h3 { color: #007BFF; }
        .stats-card .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 1.1rem;
        }
        .stats-card.light .stat-item { border-color: rgba(0, 0, 0, 0.1); }
        .stats-card .stat-item:last-child { border-bottom: none; }
        .stats-card .stat-item span {
            color: #00F7FF;
            font-weight: bold;
        }
        .stats-card.light .stat-item span { color: #007BFF; }
        .preview-image { max-width: 100%; max-height: 150px; margin-top: 8px; border-radius: 4px; border: 1px solid #00F7FF; }
        .preview-image.light { border-color: #007BFF; }
        .progress-bar {
            height: 15px;
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            color: #1E2A44;
            font-weight: bold;
        }
        .progress-bar.light { background: linear-gradient(90deg, #007BFF, #FF1493); }
        .progress-bar span { line-height: 15px; }
        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(0, 247, 255, 0.9);
            color: #1E2A44;
            padding: 8px 15px;
            border-radius: 4px;
            z-index: 1000;
            display: none;
            animation: fadeInOut 3s ease-in-out;
        }
        .notification.light { background: rgba(0, 123, 255, 0.9); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(-20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
        .theme-switch {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 35px;
            height: 35px;
            background: #00F7FF;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        .theme-switch.light { background: #007BFF; }
        .theme-switch:hover { background: #FF00E6; }
        .theme-switch.light:hover { background: #FF1493; }
        .theme-switch i { font-size: 1rem; color: #1E2A44; }
        .theme-switch.light i { color: #F0F4F8; }
        .lang-switch {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #FFF;
            border-radius: 4px;
            height: 35px;
            padding: 4px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .lang-switch.light {
            background: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.1);
            color: #333;
        }
        .lang-switch:focus {
            border-color: #00F7FF;
            box-shadow: 0 0 5px rgba(0, 247, 255, 0.5);
        }
        .lang-switch.light:focus { border-color: #007BFF; box-shadow: 0 0 5px rgba(0, 123, 255, 0.5); }
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]:hover:after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 42, 68, 0.9);
            color: #ECF0F1;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            z-index: 1;
        }
        [data-tooltip].light:hover:after {
            background: rgba(217, 226, 236, 0.9);
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <select class="lang-switch" onchange="setLanguage(this.value)">
            <option value="ru" selected>Русский</option>
            <option value="en">English</option>
        </select>
        <h1><i class="fas fa-chart-line"></i> <span data-i18n="title">Дневник трейдера</span></h1>
        <button class="theme-switch" onclick="toggleTheme()"><i class="fas fa-lightbulb"></i></button>

        <div id="main" class="card">
            <div class="row mb-2">
                <div class="col-6">
                    <label for="coin" class="form-label" data-tooltip="Выберите или добавьте монету" data-i18n="coinLabel">Монета</label>
                    <div class="d-flex">
                        <select class="form-select" id="coin" required>
                            <option value="BTCUSD">BTCUSD</option>
                            <option value="ETHUSD">ETHUSD</option>
                            <option value="XRPUSD">XRPUSD</option>
                        </select>
                        <button class="btn-add-coin" onclick="promptAddCoin()" data-tooltip="Добавить новую монету" data-i18n="addCoin">+</button>
                    </div>
                </div>
                <div class="col-6">
                    <label for="position" class="form-label" data-tooltip="Выберите тип позиции" data-i18n="positionLabel">Позиция</label>
                    <select class="form-select" id="position" required>
                        <option value="Short">Short</option>
                        <option value="Long">Long</option>
                    </select>
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-6">
                    <label for="open_date" class="form-label" data-tooltip="Выберите дату открытия сделки" data-i18n="openDateLabel">Дата открытия</label>
                    <input type="date" class="form-control" id="open_date" required>
                </div>
                <div class="col-6">
                    <label for="risk" class="form-label" data-tooltip="Введите риск в долларах" data-i18n="riskLabel">Риск на сделку ($)</label>
                    <input type="number" step="0.01" class="form-control" id="risk" required>
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-6">
                    <label for="profit" class="form-label" data-tooltip="Введите прибыль в долларах" data-i18n="profitLabel">Прибыль ($)</label>
                    <input type="number" step="0.01" class="form-control" id="profit" required>
                </div>
                <div class="col-6">
                    <label for="loss" class="form-label" data-tooltip="Введите убыток в долларах" data-i18n="lossLabel">Убыток ($)</label>
                    <input type="number" step="0.01" class="form-control" id="loss" required>
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-6">
                    <label for="result" class="form-label" data-tooltip="Введите итог сделки в процентах" data-i18n="resultLabel">Итог сделки (%)</label>
                    <input type="number" step="0.01" class="form-control" id="result" required>
                </div>
                <div class="col-6">
                    <label for="notes" class="form-label" data-tooltip="Добавьте заметки к сделке" data-i18n="notesLabel">Заметки</label>
                    <div class="d-flex">
                        <input type="text" class="form-control" id="notes">
                        <button class="btn-add-image" onclick="document.getElementById('notesImage').click()" data-tooltip="Загрузить изображение для заметок" data-i18n="addImage">📷</button>
                        <input type="file" class="form-control d-none" id="notesImage" accept="image/*" onchange="handleImageUpload(event, 'notes')">
                    </div>
                    <img id="notesImagePreview" class="preview-image" style="display: none;">
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-12">
                    <label for="setup" class="form-label" data-tooltip="Опишите сетап сделки" data-i18n="setupLabel">Сетап</label>
                    <div class="d-flex">
                        <input type="text" class="form-control" id="setup" required style="height: 60px; resize: vertical;">
                        <button class="btn-add-image" onclick="document.getElementById('setupImage').click()" data-tooltip="Загрузить изображение для сетапа" data-i18n="addImage">📷</button>
                        <input type="file" class="form-control d-none" id="setupImage" accept="image/*" onchange="handleImageUpload(event, 'setup')">
                    </div>
                    <img id="setupImagePreview" class="preview-image" style="display: none;">
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-12">
                    <label for="rating" class="form-label" data-tooltip="Оцените сделку от 1 до 5" data-i18n="ratingLabel">Оценка (1-5)</label>
                    <input type="range" class="form-range" id="rating" min="1" max="5" step="0.01" value="1" oninput="document.getElementById('ratingValue').textContent = this.value">
                    <div class="range-value" id="ratingValue">1</div>
                </div>
            </div>
            <button class="btn w-100" id="submitBtn" onclick="saveTrade()" data-i18n="submitBtn"><i class="fas fa-plus"></i> Добавить сделку</button>
            <button class="btn w-100 mt-2" id="cancelBtn" style="display: none;" onclick="cancelEdit()" data-i18n="cancelBtn">Отмена</button>
        </div>

        <div id="view" class="card" style="display: none;">
            <h3 class="text-center mb-2" style="font-size: 1.5rem; background: linear-gradient(90deg, #00F7FF, #FF00E6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;" data-i18n="myTrades">Мои сделки</h3>
            <input type="text" class="search-input" id="searchInput" placeholder="Поиск..." oninput="applyFilters()">
            <div class="progress-bar" id="successProgress"><span>0%</span></div>
            <div class="row mb-2">
                <div class="col-6">
                    <label for="filterCoin" class="form-label" data-i18n="filterCoinLabel">Фильтр по монете</label>
                    <select class="form-select" id="filterCoin" onchange="applyFilters()">
                        <option value="">Все</option>
                    </select>
                </div>
                <div class="col-6">
                    <label for="filterPosition" class="form-label" data-i18n="filterPositionLabel">Фильтр по позиции</label>
                    <select class="form-select" id="filterPosition" onchange="applyFilters()">
                        <option value="">Все</option>
                        <option value="Short">Short</option>
                        <option value="Long">Long</option>
                    </select>
                </div>
            </div>
            <table class="table" id="tradesTable">
                <thead>
                    <tr>
                        <th data-sort="id" data-i18n="id">ID</th>
                        <th data-sort="coin" data-i18n="coin">Монета</th>
                        <th data-sort="position" data-i18n="position">Позиция</th>
                        <th data-sort="open_date" data-i18n="date">Дата</th>
                        <th data-sort="risk" data-i18n="risk">Риск ($)</th>
                        <th data-sort="profit" data-i18n="profit">Прибыль ($)</th>
                        <th data-sort="loss" data-i18n="loss">Убыток ($)</th>
                        <th data-sort="result" data-i18n="result">Итог (%)</th>
                        <th data-i18n="setup">Сетап</th>
                        <th data-i18n="notes">Заметки</th>
                        <th data-sort="rating" data-i18n="rating">Оценка</th>
                        <th data-i18n="actions">Действия</th>
                    </tr>
                </thead>
                <tbody id="tradesBody"></tbody>
            </table>
            <div class="row mt-2">
                <div class="col-6">
                    <button class="btn w-100" onclick="exportToCSV()" data-i18n="exportCSV">Экспорт в CSV</button>
                </div>
                <div class="col-6">
                    <button class="btn w-100" onclick="exportToPDF()" data-i18n="exportPDF">Экспорт в PDF</button>
                </div>
            </div>
        </div>

        <div id="stats" class="card" style="display: none;">
            <div class="stats-card">
                <h3 data-i18n="stats">Статистика</h3>
                <div class="stat-item"><span data-i18n="totalTrades">Всего сделок:</span> <span id="totalTrades">0</span></div>
                <div class="stat-item"><span data-i18n="avgProfit">Средняя прибыль:</span> <span id="avgProfit">0.00</span>$</div>
                <div class="stat-item"><span data-i18n="avgLoss">Средний убыток:</span> <span id="avgLoss">0.00</span>$</div>
                <div class="stat-item"><span data-i18n="avgResult">Средний результат:</span> <span id="avgResult">0.00</span>%</div>
                <div class="stat-item"><span data-i18n="successRate">Успешных сделок:</span> <span id="successRate">0</span>%</div>
            </div>
        </div>

        <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="detailModalLabel" data-i18n="details">Детали</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="detailModalBody"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-action" data-bs-dismiss="modal" data-i18n="close">Закрыть</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="notification" id="notification"></div>
    </div>

    <nav class="navbar">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" onclick="showSection('main')" data-i18n="home"><i class="fas fa-home"></i> Главная</a>
            <a class="navbar-brand" href="#" onclick="showSection('view')" data-i18n="myTradesNav"><i class="fas fa-table"></i> Мои сделки</a>
            <a class="navbar-brand" href="#" onclick="showSection('stats')" data-i18n="statsNav"><i class="fas fa-chart-bar"></i> Статистика</a>
        </div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const translations = {
            "ru": {
                "title": "Дневник трейдера",
                "coinLabel": "Монета",
                "addCoin": "+",
                "positionLabel": "Позиция",
                "openDateLabel": "Дата открытия",
                "riskLabel": "Риск на сделку ($)",
                "profitLabel": "Прибыль ($)",
                "lossLabel": "Убыток ($)",
                "resultLabel": "Итог сделки (%)",
                "notesLabel": "Заметки",
                "addImage": "📷",
                "setupLabel": "Сетап",
                "ratingLabel": "Оценка (1-5)",
                "submitBtn": "Добавить сделку",
                "cancelBtn": "Отмена",
                "myTrades": "Мои сделки",
                "filterCoinLabel": "Фильтр по монете",
                "filterPositionLabel": "Фильтр по позиции",
                "id": "ID",
                "coin": "Монета",
                "position": "Позиция",
                "date": "Дата",
                "risk": "Риск ($)",
                "profit": "Прибыль ($)",
                "loss": "Убыток ($)",
                "result": "Итог (%)",
                "setup": "Сетап",
                "notes": "Заметки",
                "rating": "Оценка",
                "actions": "Действия",
                "exportCSV": "Экспорт в CSV",
                "exportPDF": "Экспорт в PDF",
                "stats": "Статистика",
                "totalTrades": "Всего сделок:",
                "avgProfit": "Средняя прибыль:",
                "avgLoss": "Средний убыток:",
                "avgResult": "Средний результат:",
                "successRate": "Успешных сделок:",
                "details": "Детали",
                "close": "Закрыть",
                "home": "Главная",
                "myTradesNav": "Мои сделки",
                "statsNav": "Статистика",
                "isRequired": "обязательно для заполнения",
                "cannotBeNegative": "не может быть отрицательным",
                "confirmEdit": "Вы уверены, что хотите сохранить изменения?",
                "tradeUpdated": "Сделка обновлена!",
                "tradeAdded": "Сделка добавлена!",
                "confirmDelete": "Удалить сделку с ID",
                "tradeDeleted": "Сделка удалена!",
                "noTradesToExport": "Нет сделок для экспорта!",
                "exportedToCSV": "Экспортировано в CSV!",
                "exportedToPDF": "Экспортировано в PDF!",
                "detailsBtn": "Подробнее",
                "edit": "Ред.",
                "delete": "Удал."
            },
            "en": {
                "title": "Trader's Journal",
                "coinLabel": "Coin",
                "addCoin": "+",
                "positionLabel": "Position",
                "openDateLabel": "Open Date",
                "riskLabel": "Risk ($)",
                "profitLabel": "Profit ($)",
                "lossLabel": "Loss ($)",
                "resultLabel": "Result (%)",
                "notesLabel": "Notes",
                "addImage": "📷",
                "setupLabel": "Setup",
                "ratingLabel": "Rating (1-5)",
                "submitBtn": "Add Trade",
                "cancelBtn": "Cancel",
                "myTrades": "My Trades",
                "filterCoinLabel": "Filter by Coin",
                "filterPositionLabel": "Filter by Position",
                "id": "ID",
                "coin": "Coin",
                "position": "Position",
                "date": "Date",
                "risk": "Risk ($)",
                "profit": "Profit ($)",
                "loss": "Loss ($)",
                "result": "Result (%)",
                "setup": "Setup",
                "notes": "Notes",
                "rating": "Rating",
                "actions": "Actions",
                "exportCSV": "Export to CSV",
                "exportPDF": "Export to PDF",
                "stats": "Statistics",
                "totalTrades": "Total Trades:",
                "avgProfit": "Average Profit:",
                "avgLoss": "Average Loss:",
                "avgResult": "Average Result:",
                "successRate": "Success Rate:",
                "details": "Details",
                "close": "Close",
                "home": "Home",
                "myTradesNav": "My Trades",
                "statsNav": "Statistics",
                "isRequired": "is required",
                "cannotBeNegative": "cannot be negative",
                "confirmEdit": "Are you sure you want to save changes?",
                "tradeUpdated": "Trade updated!",
                "tradeAdded": "Trade added!",
                "confirmDelete": "Delete trade with ID",
                "tradeDeleted": "Trade deleted!",
                "noTradesToExport": "No trades to export!",
                "exportedToCSV": "Exported to CSV!",
                "exportedToPDF": "Exported to PDF!",
                "detailsBtn": "Details",
                "edit": "Edit",
                "delete": "Delete"
            }
        };
        let currentLang = localStorage.getItem("lang") || "ru";
        let trades = JSON.parse(localStorage.getItem("trades")) || [];
        let coins = JSON.parse(localStorage.getItem("coins")) || ["BTCUSD", "ETHUSD", "XRPUSD"];
        let editingTradeId = null;
        let filters = { coin: "", position: "", search: "" };

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem("lang", lang);
            document.querySelectorAll("[data-i18n]").forEach(element => {
                element.textContent = translations[lang][element.getAttribute("data-i18n")] || element.textContent;
            });
            updateTable();
            updateStats();
            document.querySelector(".lang-switch").value = lang;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return `${date.getDate().toString().padStart(2, '0')}.${(date.getMonth() + 1).toString().padStart(2, '0')}.${date.getFullYear()}`;
        }

        function sortTable(column) {
            trades.sort((a, b) => {
                let valA = a[column], valB = b[column];
                if (column === "open_date") {
                    valA = new Date(a[column]);
                    valB = new Date(b[column]);
                } else if (["risk", "profit", "loss", "result", "rating"].includes(column)) {
                    valA = parseFloat(a[column]);
                    valB = parseFloat(b[column]);
                }
                return valA > valB ? 1 : valA < valB ? -1 : 0;
            });
            localStorage.setItem("trades", JSON.stringify(trades));
            updateTable();
        }

        function validateForm() {
            const requiredFields = ["coin", "position", "open_date", "risk", "profit", "loss", "result", "setup"];
            for (let field of requiredFields) {
                if (!document.getElementById(field).value.trim()) {
                    showNotification(`${document.querySelector(`label[for="${field}"]`).textContent} ${translations[currentLang]["isRequired"]}!`);
                    return false;
                }
            }
            const numericFields = ["risk", "profit", "loss"];
            for (let field of numericFields) {
                if (parseFloat(document.getElementById(field).value) < 0) {
                    showNotification(`${document.querySelector(`label[for="${field}"]`).textContent} ${translations[currentLang]["cannotBeNegative"]}!`);
                    return false;
                }
            }
            return true;
        }

        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");
                    const maxWidth = 800;
                    const maxHeight = 600;
                    let width = img.width, height = img.height;
                    if (width > height) {
                        if (width > maxWidth) {
                            height = Math.round(height * maxWidth / width);
                            width = maxWidth;
                        }
                    } else if (height > maxHeight) {
                        width = Math.round(width * maxHeight / height);
                        height = maxHeight;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    callback(canvas.toDataURL("image/jpeg", 0.7));
                };
            };
        }

        function handleImageUpload(event, type) {
            const file = event.target.files[0];
            if (file) {
                compressImage(file, compressedImage => {
                    const previewId = `${type}ImagePreview`;
                    document.getElementById(previewId).src = compressedImage;
                    document.getElementById(previewId).style.display = "block";
                    showNotification("Image uploaded!");
                });
            }
        }

        function promptAddCoin() {
            const newCoin = prompt(translations[currentLang]["coinLabel"] + ":");
            if (newCoin && newCoin.trim() && !coins.includes(newCoin.trim())) {
                coins.push(newCoin.trim());
                localStorage.setItem("coins", JSON.stringify(coins));
                updateCoinSelect();
                updateFilterCoinOptions();
                showNotification(translations[currentLang]["coinLabel"] + " added!");
            } else if (newCoin) {
                showNotification(translations[currentLang]["coinLabel"] + " already exists or is empty!");
            }
        }

        function updateCoinSelect() {
            const select = document.getElementById("coin");
            select.innerHTML = coins.map(coin => `<option value="${coin}">${coin}</option>`).join("");
        }

        function updateFilterCoinOptions() {
            const filterCoin = document.getElementById("filterCoin");
            filterCoin.innerHTML = '<option value="">Все</option>' + coins.map(coin => `<option value="${coin}">${coin}</option>`).join("");
            filterCoin.value = filters.coin;
        }

        function applyFilters() {
            filters.coin = document.getElementById("filterCoin").value;
            filters.position = document.getElementById("filterPosition").value;
            filters.search = document.getElementById("searchInput").value.toLowerCase();
            updateTable();
        }

        function editTrade(id) {
            const trade = trades.find(t => t.id === id);
            if (trade) {
                editingTradeId = id;
                document.getElementById("coin").value = trade.coin;
                document.getElementById("position").value = trade.position;
                document.getElementById("open_date").value = trade.open_date;
                document.getElementById("risk").value = trade.risk;
                document.getElementById("profit").value = trade.profit;
                document.getElementById("loss").value = trade.loss;
                document.getElementById("result").value = trade.result;
                document.getElementById("setup").value = trade.setup;
                document.getElementById("notes").value = trade.notes || "";
                document.getElementById("rating").value = trade.rating;
                document.getElementById("ratingValue").textContent = trade.rating;
                if (trade.setupImage) {
                    document.getElementById("setupImagePreview").src = trade.setupImage;
                    document.getElementById("setupImagePreview").style.display = "block";
                }
                if (trade.notesImage) {
                    document.getElementById("notesImagePreview").src = trade.notesImage;
                    document.getElementById("notesImagePreview").style.display = "block";
                }
                document.getElementById("submitBtn").textContent = "Сохранить изменения";
                document.getElementById("cancelBtn").style.display = "block";
                showSection("main");
            }
        }

        function saveTrade() {
            if (!validateForm()) return;
            const loading = document.createElement("div");
            loading.className = "notification";
            loading.textContent = "Сохранение...";
            document.body.appendChild(loading);
            setTimeout(() => {
                if (editingTradeId && !confirm(translations[currentLang]["confirmEdit"])) {
                    document.body.removeChild(loading);
                    return;
                }
                const tradeData = {
                    id: editingTradeId || trades.length + 1,
                    coin: document.getElementById("coin").value,
                    position: document.getElementById("position").value,
                    open_date: document.getElementById("open_date").value,
                    risk: parseFloat(document.getElementById("risk").value),
                    profit: parseFloat(document.getElementById("profit").value),
                    loss: parseFloat(document.getElementById("loss").value),
                    result: parseFloat(document.getElementById("result").value),
                    setup: document.getElementById("setup").value,
                    notes: document.getElementById("notes").value,
                    rating: parseFloat(document.getElementById("rating").value),
                    setupImage: document.getElementById("setupImagePreview").src || "",
                    notesImage: document.getElementById("notesImagePreview").src || ""
                };
                if (editingTradeId) {
                    const index = trades.findIndex(t => t.id === editingTradeId);
                    trades[index] = tradeData;
                    showNotification(translations[currentLang]["tradeUpdated"]);
                } else {
                    trades.push(tradeData);
                    showNotification(translations[currentLang]["tradeAdded"]);
                }
                localStorage.setItem("trades", JSON.stringify(trades));
                autoSave();
                clearForm();
                updateTable();
                updateStats();
                editingTradeId = null;
                document.getElementById("submitBtn").textContent = translations[currentLang]["submitBtn"];
                document.getElementById("cancelBtn").style.display = "none";
                document.body.removeChild(loading);
            }, 500);
        }

        function cancelEdit() {
            editingTradeId = null;
            clearForm();
            document.getElementById("submitBtn").textContent = translations[currentLang]["submitBtn"];
            document.getElementById("cancelBtn").style.display = "none";
            showSection("main");
        }

        function clearForm() {
            document.getElementById("coin").value = "BTCUSD";
            document.getElementById("position").value = "Short";
            document.getElementById("open_date").value = new Date().toISOString().split("T")[0];
            document.getElementById("risk").value = "";
            document.getElementById("profit").value = "";
            document.getElementById("loss").value = "";
            document.getElementById("result").value = "";
            document.getElementById("setup").value = "";
            document.getElementById("notes").value = "";
            document.getElementById("rating").value = "1";
            document.getElementById("ratingValue").textContent = "1";
            document.getElementById("setupImagePreview").style.display = "none";
            document.getElementById("notesImagePreview").style.display = "none";
        }

        function updateTable() {
            const tbody = document.getElementById("tradesBody");
            tbody.innerHTML = "";
            const filteredTrades = trades.filter(trade => {
                const matchesCoin = !filters.coin || trade.coin === filters.coin;
                const matchesPosition = !filters.position || trade.position === filters.position;
                const matchesSearch = !filters.search || Object.values(trade).some(val => val.toString().toLowerCase().includes(filters.search));
                return matchesCoin && matchesPosition && matchesSearch;
            });
            filteredTrades.forEach(trade => {
                const row = document.createElement("tr");
                row.classList.add("fade-in");
                row.setAttribute("data-trade-id", trade.id);
                row.addEventListener("click", () => toggleAccordion(row));
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    row.innerHTML = `
                        <td data-label="${translations[currentLang]['id']}">${trade.id}</td>
                        <td data-label="${translations[currentLang]['coin']}">${trade.coin}</td>
                        <td data-label="${translations[currentLang]['position']}">${trade.position}</td>
                        <td data-label="${translations[currentLang]['date']}">${formatDate(trade.open_date)}</td>
                        <td data-label="${translations[currentLang]['risk']}">${trade.risk.toFixed(2)}</td>
                        <td data-label="${translations[currentLang]['profit']}">${trade.profit.toFixed(2)}</td>
                        <td data-label="${translations[currentLang]['loss']}">${trade.loss.toFixed(2)}</td>
                        <td data-label="${translations[currentLang]['result']}">${trade.result.toFixed(2)}</td>
                        <td data-label="${translations[currentLang]['setup']}"></td>
                        <td data-label="${translations[currentLang]['notes']}"></td>
                        <td data-label="${translations[currentLang]['rating']}">${trade.rating.toFixed(2)}</td>
                        <td class="actions-cell">
                            <button class="btn-action btn-sm" onclick="editTrade(${trade.id}); event.stopPropagation();" data-i18n="edit">Ред.</button>
                            <button class="btn-action btn-sm" onclick="deleteTrade(${trade.id}); event.stopPropagation();" data-i18n="delete">Удал.</button>
                        </td>
                    `;
                    const accordionContent = document.createElement("td");
                    accordionContent.colSpan = 12;
                    accordionContent.classList.add("accordion-content");
                    accordionContent.innerHTML = `
                        <p><strong>${translations[currentLang]['setup']}:</strong> ${trade.setup || "Нет данных"}</p>
                        ${trade.setupImage ? `<img src="${trade.setupImage}" alt="Setup Image">` : ""}
                        <p><strong>${translations[currentLang]['notes']}:</strong> ${trade.notes || "Нет заметок"}</p>
                        ${trade.notesImage ? `<img src="${trade.notesImage}" alt="Notes Image">` : ""}
                    `;
                    row.appendChild(accordionContent);
                } else {
                    row.innerHTML = `
                        <td>${trade.id}</td>
                        <td>${trade.coin}</td>
                        <td>${trade.position}</td>
                        <td>${formatDate(trade.open_date)}</td>
                        <td>${trade.risk.toFixed(2)}</td>
                        <td>${trade.profit.toFixed(2)}</td>
                        <td>${trade.loss.toFixed(2)}</td>
                        <td>${trade.result.toFixed(2)}</td>
                        <td class="setup-cell"><button class="btn-action btn-sm" onclick="showDetailModal(${trade.id}, 'setup')" data-i18n="detailsBtn">Подробнее</button></td>
                        <td class="notes-cell"><button class="btn-action btn-sm" onclick="showDetailModal(${trade.id}, 'notes')" data-i18n="detailsBtn">Подробнее</button></td>
                        <td>${trade.rating.toFixed(2)}</td>
                        <td class="actions-cell">
                            <button class="btn-action btn-sm" onclick="editTrade(${trade.id})" data-i18n="edit">Ред.</button>
                            <button class="btn-action btn-sm" onclick="deleteTrade(${trade.id})" data-i18n="delete">Удал.</button>
                        </td>
                    `;
                }
                tbody.appendChild(row);
            });
            updateProgressBar();
            document.querySelectorAll("#tradesBody .btn-action").forEach(btn => {
                btn.textContent = translations[currentLang][btn.getAttribute("data-i18n")] || btn.textContent;
            });
        }

        function toggleAccordion(row) {
            const accordionContent = row.querySelector(".accordion-content");
            if (accordionContent) {
                document.querySelectorAll(".accordion-content.active").forEach(content => content.classList.remove("active"));
                accordionContent.classList.toggle("active");
            }
        }

        function updateProgressBar() {
            const totalTrades = trades.length;
            const successfulTrades = totalTrades ? trades.filter(t => t.result > 0).length / totalTrades * 100 : 0;
            const progressBar = document.getElementById("successProgress");
            progressBar.style.width = `${successfulTrades}%`;
            progressBar.firstChild.textContent = `${successfulTrades.toFixed(2)}%`;
        }

        function updateStats() {
            const totalTrades = trades.length;
            const avgProfit = totalTrades ? (trades.reduce((sum, t) => sum + t.profit, 0) / totalTrades).toFixed(2) : 0;
            const avgLoss = totalTrades ? (trades.reduce((sum, t) => sum + t.loss, 0) / totalTrades).toFixed(2) : 0;
            const avgResult = totalTrades ? (trades.reduce((sum, t) => sum + t.result, 0) / totalTrades).toFixed(2) : 0;
            const successRate = totalTrades ? (trades.filter(t => t.result > 0).length / totalTrades * 100).toFixed(2) : 0;

            document.getElementById("totalTrades").textContent = totalTrades;
            document.getElementById("avgProfit").textContent = avgProfit;
            document.getElementById("avgLoss").textContent = avgLoss;
            document.getElementById("avgResult").textContent = avgResult;
            document.getElementById("successRate").textContent = successRate;
            updateProgressBar();
        }

        function showDetailModal(id, type) {
            const trade = trades.find(t => t.id === id);
            if (trade) {
                const modalBody = document.getElementById("detailModalBody");
                modalBody.innerHTML = type === "setup" ? trade.setup || "Нет данных" : trade.notes || "Нет заметок";
                if ((type === "setup" && trade.setupImage) || (type === "notes" && trade.notesImage)) {
                    const img = document.createElement("img");
                    img.src = type === "setup" ? trade.setupImage : trade.notesImage;
                    img.classList.add("preview-image");
                    modalBody.appendChild(img);
                }
                new bootstrap.Modal(document.getElementById("detailModal")).show();
            }
        }

        function deleteTrade(id) {
            if (confirm(`${translations[currentLang]["confirmDelete"]} ${id}?`)) {
                trades = trades.filter(t => t.id !== id).map((t, i) => ({ ...t, id: i + 1 }));
                localStorage.setItem("trades", JSON.stringify(trades));
                autoSave();
                updateTable();
                updateStats();
                showNotification(translations[currentLang]["tradeDeleted"]);
            }
        }

        function exportToCSV() {
            if (!trades.length) {
                showNotification(translations[currentLang]["noTradesToExport"]);
                return;
            }
            const headers = ["ID", "Coin", "Position", "Date", "Risk ($)", "Profit ($)", "Loss ($)", "Result (%)", "Setup", "Notes", "Rating"];
            const rows = trades.map(t => [
                t.id, t.coin, t.position, formatDate(t.open_date), t.risk.toFixed(2), t.profit.toFixed(2),
                t.loss.toFixed(2), t.result.toFixed(2), `"${t.setup.replace(/"/g, '""')}"`, `"${t.notes || ""}"`, t.rating.toFixed(2)
            ]);
            const csv = [headers.join(","), ...rows.map(r => r.join(","))].join("\n");
            const blob = new Blob([csv], { type: "text/csv" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "trades.csv";
            link.click();
            showNotification(translations[currentLang]["exportedToCSV"]);
        }

        function exportToPDF() {
            if (!trades.length) {
                showNotification(translations[currentLang]["noTradesToExport"]);
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(translations[currentLang]["myTrades"], 10, 10);
            doc.autoTable({
                head: [["ID", "Coin", "Position", "Date", "Risk ($)", "Profit ($)", "Loss ($)", "Result (%)", "Rating"]],
                body: trades.map(t => [
                    t.id, t.coin, t.position, formatDate(t.open_date), t.risk.toFixed(2), t.profit.toFixed(2),
                    t.loss.toFixed(2), t.result.toFixed(2), t.rating.toFixed(2)
                ]),
                startY: 20,
                theme: "grid"
            });
            doc.save("trades.pdf");
            showNotification(translations[currentLang]["exportedToPDF"]);
        }

        function showNotification(message) {
            const notification = document.getElementById("notification");
            notification.textContent = message;
            notification.style.display = "block";
            setTimeout(() => notification.style.display = "none", 3000);
        }

        function autoSave() {
            localStorage.setItem("trades", JSON.stringify(trades));
            localStorage.setItem("coins", JSON.stringify(coins));
        }

        function toggleTheme() {
            document.body.classList.toggle("light");
            document.querySelectorAll(".card, .form-control, .form-select, .table, .btn, .btn-action, .btn-add-coin, .btn-add-image, .navbar, .modal-content, .preview-image, .progress-bar, .notification, .theme-switch, .lang-switch, .search-input, .stats-card").forEach(el => el.classList.toggle("light"));
            localStorage.setItem("theme", document.body.classList.contains("light") ? "light" : "dark");
        }

        function showSection(sectionId) {
            document.querySelectorAll("#main, #view, #stats").forEach(s => s.style.display = s.id === sectionId ? "block" : "none");
            document.querySelectorAll(".navbar-brand").forEach(b => b.classList.toggle("active", b.getAttribute("onclick").includes(sectionId)));
            if (sectionId === "stats") updateStats();
        }

        document.addEventListener("DOMContentLoaded", () => {
            if (localStorage.getItem("theme") === "light") toggleTheme();
            setLanguage(currentLang);
            updateCoinSelect();
            updateFilterCoinOptions();
            document.getElementById("filterCoin").value = filters.coin;
            document.getElementById("filterPosition").value = filters.position;
            updateTable();
            showSection("main"); // Отображение главной формы при загрузке
            document.querySelectorAll("#tradesTable th[data-sort]").forEach(th => th.addEventListener("click", () => sortTable(th.getAttribute("data-sort"))));
            document.querySelectorAll("[data-tooltip]").forEach(element => {
                element.addEventListener("mouseover", () => {
                    const tooltip = document.createElement("div");
                    tooltip.className = `notification ${document.body.classList.contains("light") ? "light" : ""}`;
                    tooltip.textContent = element.getAttribute("data-tooltip");
                    tooltip.style.position = "absolute";
                    tooltip.style.bottom = "100%";
                    tooltip.style.left = "50%";
                    tooltip.style.transform = "translateX(-50%)";
                    tooltip.style.padding = "4px 8px";
                    tooltip.style.borderRadius = "4px";
                    tooltip.style.zIndex = "1000";
                    element.appendChild(tooltip);
                });
                element.addEventListener("mouseout", () => {
                    const tooltip = element.querySelector(".notification");
                    if (tooltip) tooltip.remove();
                });
            });
        });
    </script>
</body>
</html>
