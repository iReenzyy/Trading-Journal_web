<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дневник трейдера</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: linear-gradient(135deg, #1E2A44 0%, #0F172A 100%);
            color: #ECF0F1;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .container {
            padding: 30px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: fadeIn 1.5s ease-in-out;
        }
        .card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 247, 255, 0.2);
        }
        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #000;
            border-radius: 8px;
            transition: all 0.3s ease;
            height: 40px;
        }
        .form-control:focus, .form-select:focus {
            background: rgba(255, 255, 255, 0.4);
            border-color: #00F7FF;
            box-shadow: 0 0 10px rgba(0, 247, 255, 0.5);
            color: #000;
        }
        .form-select option {
            background: #fff;
            color: #000;
        }
        .form-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            color: #A0B1C5;
        }
        .btn {
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            border: none;
            border-radius: 8px;
            padding: 5px 10px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
            box-shadow: 0 0 5px rgba(0, 247, 255, 0.5);
        }
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0, 247, 255, 0.8);
        }
        .btn-action {
            background: #1E2A44;
            color: #00F7FF;
            border: 1px solid #00F7FF;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin: 0 2px;
            transition: all 0.3s ease;
        }
        .btn-action:hover {
            background: #00F7FF;
            color: #1E2A44;
            box-shadow: 0 0 5px #00F7FF;
        }
        .table {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        .table th {
            background: rgba(255, 255, 255, 0.15);
            color: #00F7FF;
            text-transform: uppercase;
            font-size: 0.9rem;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }
        .table td {
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #ECF0F1;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            max-width: 0;
        }
        .table td.setup-cell {
            max-width: 100px; /* Ограничение ширины для "Сетап" */
        }
        .table td.setup-cell:hover {
            overflow: visible;
            white-space: normal;
        }
        .navbar {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px 0;
        }
        .navbar-brand {
            color: #ECF0F1;
            font-size: 0.9rem;
            padding: 10px 15px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        .navbar-brand:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #00F7FF;
            box-shadow: 0 0 10px rgba(0, 247, 255, 0.5);
        }
        #stats {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(15px);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        #stats h3 {
            color: #00F7FF;
            margin-bottom: 15px;
        }
        #stats p {
            margin: 10px 0;
            font-size: 1.1rem;
            color: #A0B1C5;
        }
        #stats span {
            color: #00F7FF;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .range-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #A0B1C5;
            margin-top: 5px;
        }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            background: linear-gradient(90deg, #00F7FF, #FF00E6);
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #00F7FF;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px #00F7FF, 0 0 10px #FF00E6;
            transition: transform 0.3s ease;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #00F7FF;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px #00F7FF, 0 0 10px #FF00E6;
            transition: transform 0.3s ease;
        }
        .modal-content {
            background: rgba(15, 23, 42, 0.9);
            color: #ECF0F1;
            border: 1px solid #00F7FF;
            border-radius: 10px;
        }
        .modal-header {
            border-bottom: 1px solid #00F7FF;
        }
        .modal-footer {
            border-top: 1px solid #00F7FF;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .navbar-brand { font-size: 0.8rem; padding: 8px; }
            .form-label { font-size: 0.8rem; }
            .btn { padding: 8px 15px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="fade-in"><i class="fas fa-chart-line"></i> ДНЕВНИК ТРЕЙДЕРА</h1>

        <!-- Форма добавления монеты -->
        <div id="addCoin" class="card fade-in" style="display: none;">
            <label for="newCoin" class="form-label">Новая монета</label>
            <div class="row mb-3">
                <div class="col-md-8">
                    <input type="text" class="form-control" id="newCoin" placeholder="Введите название монеты">
                </div>
                <div class="col-md-4">
                    <button class="btn w-100" onclick="addCoin()">Добавить монету</button>
                </div>
            </div>
        </div>

        <!-- Форма добавления сделки -->
        <div id="main" class="card fade-in">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="coin" class="form-label">Монета</label>
                    <select class="form-select" id="coin" required>
                        <option value="BTCUSD">BTCUSD</option>
                        <option value="ETHUSD">ETHUSD</option>
                        <option value="XRPUSD">XRPUSD</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="position" class="form-label">Позиция</label>
                    <select class="form-select" id="position" required>
                        <option value="Short">Short</option>
                        <option value="Long">Long</option>
                    </select>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="open_date" class="form-label">Дата открытия</label>
                    <input type="text" class="form-control" id="open_date" required>
                </div>
                <div class="col-md-6">
                    <label for="risk" class="form-label">Риск на сделку ($)</label>
                    <input type="number" step="0.01" class="form-control" id="risk" required>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="profit" class="form-label">Прибыль ($)</label>
                    <input type="number" step="0.01" class="form-control" id="profit" required>
                </div>
                <div class="col-md-6">
                    <label for="loss" class="form-label">Убыток ($)</label>
                    <input type="number" step="0.01" class="form-control" id="loss" required>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="result" class="form-label">Итог сделки (%)</label>
                    <input type="number" step="0.01" class="form-control" id="result" required>
                </div>
                <div class="col-md-6">
                    <label for="notes" class="form-label">Заметки</label>
                    <input type="text" class="form-control" id="notes">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-12">
                    <label for="setup" class="form-label">Сетап</label>
                    <input type="text" class="form-control" id="setup" required style="height: 80px; resize: vertical;">
                    <input type="file" class="form-control mt-2" id="setupImage" accept="image/*" onchange="handleImageUpload(event)">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-12">
                    <label for="rating" class="form-label">Оценка (1-5)</label>
                    <input type="range" class="form-range" id="rating" min="1" max="5" step="0.1" value="1" oninput="updateRatingLabel(this.value)">
                    <div class="range-label">
                        <span>1</span>
                        <span>2</span>
                        <span>3</span>
                        <span>4</span>
                        <span>5</span>
                    </div>
                </div>
            </div>
            <button class="btn w-100" onclick="addTrade()"><i class="fas fa-plus"></i> Добавить сделку</button>
            <button class="btn w-100 mt-2" onclick="showSection('addCoin')">Добавить монету</button>
        </div>

        <!-- Таблица сделок -->
        <div id="view" class="card fade-in">
            <h3 class="text-center mb-3" style="font-size: 2rem; background: linear-gradient(90deg, #00F7FF, #FF00E6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Мои сделки</h3>
            <table class="table table-striped" id="tradesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Монета</th>
                        <th>Позиция</th>
                        <th>Дата</th>
                        <th>Риск ($)</th>
                        <th>Прибыль ($)</th>
                        <th>Убыток ($)</th>
                        <th>Итог (%)</th>
                        <th>Сетап</th>
                        <th>Заметки</th>
                        <th>Оценка</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="tradesBody"></tbody>
            </table>
            <button class="btn w-100 mt-3" onclick="exportToCSV()">Экспорт в CSV</button>
        </div>

        <!-- Статистика -->
        <div id="stats" class="card fade-in">
            <h3 class="text-center mb-3">Статистика</h3>
            <p>Всего сделок: <span id="totalTrades">0</span></p>
            <p>Средняя прибыль: <span id="avgProfit">0.00</span>$</p>
            <p>Средний убыток: <span id="avgLoss">0.00</span>$</p>
            <p>Средний результат: <span id="avgResult">0.00</span>%</p>
            <p>Процент успешных сделок: <span id="successRate">0</span>%</p>
        </div>

        <!-- Модальное окно для "Сетап" -->
        <div class="modal fade" id="setupModal" tabindex="-1" aria-labelledby="setupModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="setupModalLabel">Полный текст Сетап</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="setupModalBody">
                        <!-- Текст и изображение будут вставляться сюда -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-action" data-bs-dismiss="modal">Закрыть</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Нижняя панель навигации -->
    <nav class="navbar navbar-dark fixed-bottom">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" onclick="showSection('main')"><i class="fas fa-home"></i> Главная</a>
            <a class="navbar-brand" href="#" onclick="showSection('edit')"><i class="fas fa-edit"></i> Редактировать</a>
            <a class="navbar-brand" href="#" onclick="showSection('delete')"><i class="fas fa-trash"></i> Удалить</a>
            <a class="navbar-brand" href="#" onclick="showSection('view')"><i class="fas fa-table"></i> Просмотр</a>
            <a class="navbar-brand" href="#" onclick="showSection('stats')"><i class="fas fa-chart-bar"></i> Статистика</a>
        </div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let trades = JSON.parse(localStorage.getItem("trades")) || [];
        let coins = JSON.parse(localStorage.getItem("coins")) || ["BTCUSD", "ETHUSD", "XRPUSD"];
        let images = JSON.parse(localStorage.getItem("images")) || {};

        // Обновление значения оценки на ползунке
        function updateRatingLabel(value) {
            const ratingInput = document.getElementById("rating");
            const roundedValue = Math.round(value);
            ratingInput.value = roundedValue;
        }

        // Обработка загрузки изображения
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    images["setupImage"] = e.target.result; // Сохраняем base64
                    localStorage.setItem("images", JSON.stringify(images));
                };
                reader.readAsDataURL(file);
            }
        }

        // Добавление монеты
        function addCoin() {
            const newCoin = document.getElementById("newCoin").value.trim();
            if (newCoin && !coins.includes(newCoin)) {
                coins.push(newCoin);
                localStorage.setItem("coins", JSON.stringify(coins));
                updateCoinSelect();
                document.getElementById("newCoin").value = "";
                showSection('main');
                alert("Монета добавлена!");
            } else {
                alert("Монета уже существует или поле пустое!");
            }
        }

        // Обновление списка монет
        function updateCoinSelect() {
            const select = document.getElementById("coin");
            select.innerHTML = "";
            coins.forEach(coin => {
                const option = document.createElement("option");
                option.value = coin;
                option.textContent = coin;
                select.appendChild(option);
            });
        }

        // Добавление сделки
        function addTrade() {
            const trade = {
                id: trades.length + 1,
                coin: document.getElementById("coin").value,
                position: document.getElementById("position").value,
                open_date: document.getElementById("open_date").value,
                risk: parseFloat(document.getElementById("risk").value) || 0,
                profit: parseFloat(document.getElementById("profit").value) || 0,
                loss: parseFloat(document.getElementById("loss").value) || 0,
                result: parseFloat(document.getElementById("result").value) || 0,
                setup: document.getElementById("setup").value,
                notes: document.getElementById("notes").value,
                rating: parseInt(document.getElementById("rating").value) || 1,
                image: images["setupImage"] || ""
            };
            trades.push(trade);
            localStorage.setItem("trades", JSON.stringify(trades));
            clearForm();
            updateTable();
            updateStats();
            alert("Сделка добавлена!");
        }

        // Очистка формы
        function clearForm() {
            document.getElementById("coin").value = "BTCUSD";
            document.getElementById("position").value = "Short";
            document.getElementById("open_date").value = new Date().toISOString().split('T')[0].replace(/-/g, '/');
            document.getElementById("risk").value = "";
            document.getElementById("profit").value = "";
            document.getElementById("loss").value = "";
            document.getElementById("result").value = "";
            document.getElementById("setup").value = "";
            document.getElementById("notes").value = "";
            document.getElementById("rating").value = "1";
            document.getElementById("setupImage").value = "";
            images = {};
            localStorage.setItem("images", JSON.stringify(images));
        }

        // Обновление таблицы
        function updateTable() {
            const tbody = document.getElementById("tradesBody");
            tbody.innerHTML = "";
            trades.forEach(trade => {
                const row = document.createElement("tr");
                row.classList.add("fade-in");
                row.innerHTML = `
                    <td>${trade.id}</td>
                    <td>${trade.coin}</td>
                    <td>${trade.position}</td>
                    <td>${trade.open_date}</td>
                    <td>${trade.risk.toFixed(2)}</td>
                    <td>${trade.profit.toFixed(2)}</td>
                    <td>${trade.loss.toFixed(2)}</td>
                    <td>${trade.result.toFixed(2)}</td>
                    <td class="setup-cell"><span title="${trade.setup}">${trade.setup.substring(0, 20)}${trade.setup.length > 20 ? "..." : ""}</span> <button class="btn-action btn-sm" onclick="showSetupModal(${trade.id})">Подробнее</button></td>
                    <td>${trade.notes || ''}</td>
                    <td>${trade.rating}</td>
                    <td>
                        <button class="btn-action btn-sm" onclick="editTrade(${trade.id})">Ред.</button>
                        <button class="btn-action btn-sm" onclick="deleteTrade(${trade.id})">Удал.</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Показ модального окна с полным текстом "Сетап"
        function showSetupModal(id) {
            const trade = trades.find(t => t.id === id);
            if (trade) {
                const modalBody = document.getElementById("setupModalBody");
                modalBody.innerHTML = `<p>${trade.setup}</p>`;
                if (trade.image) {
                    modalBody.innerHTML += `<img src="${trade.image}" alt="Setup Image" style="max-width: 100%; margin-top: 10px;">`;
                }
                new bootstrap.Modal(document.getElementById('setupModal')).show();
            }
        }

        // Редактирование сделки
        function editTrade(id) {
            const trade = trades.find(t => t.id === id);
            if (trade) {
                document.getElementById("coin").value = trade.coin;
                document.getElementById("position").value = trade.position;
                document.getElementById("open_date").value = trade.open_date;
                document.getElementById("risk").value = trade.risk;
                document.getElementById("profit").value = trade.profit;
                document.getElementById("loss").value = trade.loss;
                document.getElementById("result").value = trade.result;
                document.getElementById("setup").value = trade.setup;
                document.getElementById("notes").value = trade.notes || "";
                document.getElementById("rating").value = trade.rating;
                trades = trades.filter(t => t.id !== id);
                localStorage.setItem("trades", JSON.stringify(trades));
                updateTable();
                showSection('main');
            }
        }

        // Удаление сделки
        function deleteTrade(id) {
            if (confirm(`Удалить сделку с ID ${id}?`)) {
                trades = trades.filter(t => t.id !== id);
                localStorage.setItem("trades", JSON.stringify(trades));
                updateTable();
                updateStats();
                alert("Сделка удалена!");
            }
        }

        // Экспорт в CSV
        function exportToCSV() {
            if (trades.length === 0) {
                alert("Нет сделок для экспорта!");
                return;
            }
            let csv = "ID,Монета,Позиция,Дата,Риск,Прибыль,Убыток,Итог,Сетап,Заметки,Оценка\n";
            trades.forEach(trade => {
                csv += `${trade.id},${trade.coin},${trade.position},${trade.open_date},${trade.risk},${trade.profit},${trade.loss},${trade.result},${trade.setup},${trade.notes || ''},${trade.rating}\n`;
            });
            const blob = new Blob([csv], { type: "text/csv" });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "trading_journal.csv";
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Обновление статистики
        function updateStats() {
            if (trades.length === 0) {
                document.getElementById("totalTrades").textContent = "0";
                document.getElementById("avgProfit").textContent = "0.00";
                document.getElementById("avgLoss").textContent = "0.00";
                document.getElementById("avgResult").textContent = "0.00";
                document.getElementById("successRate").textContent = "0";
                return;
            }
            const totalProfit = trades.reduce((sum, t) => sum + t.profit, 0);
            const totalLoss = trades.reduce((sum, t) => sum + t.loss, 0);
            const totalResult = trades.reduce((sum, t) => sum + t.result, 0);
            const successfulTrades = trades.filter(t => t.result > 0).length;
            document.getElementById("totalTrades").textContent = trades.length;
            document.getElementById("avgProfit").textContent = (totalProfit / trades.length).toFixed(2);
            document.getElementById("avgLoss").textContent = (totalLoss / trades.length).toFixed(2);
            document.getElementById("avgResult").textContent = (totalResult / trades.length).toFixed(2);
            document.getElementById("successRate").textContent = ((successfulTrades / trades.length) * 100).toFixed(2);
        }

        // Показать секцию
        function showSection(section) {
            const sections = ['main', 'addCoin', 'view', 'stats'];
            sections.forEach(s => {
                const element = document.querySelector(`#${s}`);
                if (element) element.style.display = s === section ? 'block' : 'none';
            });
            if (section === 'edit' || section === 'delete') {
                showSection('view');
            }
            if (section === 'main') clearForm();
            if (section === 'view') updateTable();
            if (section === 'stats') updateStats();
        }

        // Инициализация
        document.addEventListener("DOMContentLoaded", () => {
            const savedCoins = JSON.parse(localStorage.getItem("coins")) || ["BTCUSD", "ETHUSD", "XRPUSD"];
            coins = savedCoins;
            updateCoinSelect();
            clearForm();
            updateTable();
            updateStats();
            showSection('main');
            document.getElementById("open_date").value = new Date().toISOString().split('T')[0].replace(/-/g, '/');
        });
    </script>
</body>
</html>